<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ªãch V·ª• - VietLinker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }
        .container { background: white; min-height: 100vh; }
        
        /* Header */
        header {
            background: linear-gradient(135deg, #1e3c72 0%, #dc143c 100%);
            color: white; padding: 20px; text-align: center; position: relative; overflow: hidden;
        }
        header::before {
            content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        header h1 { font-size: 1.8em; margin-bottom: 5px; position: relative; z-index: 1; }
        header p { font-size: 0.95em; opacity: 0.95; position: relative; z-index: 1; }
        
        /* Navigation */
        nav {
            background: #1e3c72; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 100;
        }
        .nav-wrapper { display: flex; justify-content: space-between; align-items: center; }
        .nav-toggle { display: block; background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; }
        .nav-links { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #1e3c72; flex-direction: column; padding: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .nav-links.active { display: flex; }
        .nav-links a { color: white; text-decoration: none; padding: 12px; border-radius: 5px; transition: all 0.3s; }
        .nav-links a:hover, .nav-links a.active { background: rgba(220, 20, 60, 0.3); }
        .user-info { color: white; display: flex; align-items: center; gap: 10px; font-size: 0.9em; }
        .logout-btn { background: #dc143c; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; transition: all 0.3s; font-size: 0.85em; }
        .logout-btn:hover { background: #b91c3c; transform: scale(1.05); }
        
        /* Main Content */
        .main-content { padding: 20px; background: #f8f9fa; }
        
        /* Actions Bar */
        .actions-bar {
            display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;
            background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .search-filter-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 200px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        .search-box:focus { outline: none; border-color: #1e3c72; }
        .filter-btn { background: #1e3c72; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; }
        .filter-btn:hover { background: #2a5298; transform: translateY(-2px); }
        .post-btn { background: #dc143c; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-weight: 600; font-size: 14px; }
        .post-btn:hover { background: #b91c3c; transform: translateY(-2px); }
        
        /* Services Grid */
        .services-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .service-card {
            background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s; cursor: pointer; position: relative;
        }
        .service-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .service-image { width: 100%; height: 200px; object-fit: cover; background: #f0f0f0; }
        .service-content { padding: 15px; }
        .service-title { font-size: 1.2em; font-weight: 600; margin-bottom: 8px; color: #333; }
        .service-type { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8em; display: inline-block; margin-bottom: 10px; }
        .service-description { color: #666; line-height: 1.5; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .service-details { display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.9em; color: #555; }
        .service-detail-item { display: flex; align-items: center; gap: 5px; }
        .service-actions { display: flex; gap: 10px; margin-top: 15px; }
        .action-btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em; transition: all 0.3s; }
        .book-btn { background: #dc143c; color: white; }
        .chat-btn { background: #1e3c72; color: white; }
        .share-btn { background: #28a745; color: white; }
        
        /* Experience Badge */
        .experience-badge {
            position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9);
            padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600;
            color: #1e3c72; backdrop-filter: blur(5px);
        }
        
        /* Loading */
        .loading { display: flex; justify-content: center; align-items: center; padding: 40px; color: #666; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #1e3c72; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Footer */
        footer { background: #1e3c72; color: white; padding: 30px 20px; margin-top: 40px; }
        .footer-content { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; }
        .footer-column h4 { margin-bottom: 15px; color: #FFD700; }
        .footer-column ul { list-style: none; }
        .footer-column ul li { margin-bottom: 8px; }
        .footer-column ul li a { color: white; text-decoration: none; transition: color 0.3s; }
        .footer-column ul li a:hover { color: #FFD700; }
        .footer-bottom { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .services-grid { grid-template-columns: 1fr; gap: 15px; }
            .search-filter-row { flex-direction: column; }
            .search-box { min-width: auto; }
            .service-actions { flex-direction: column; }
            .action-btn { width: 100%; text-align: center; }
        }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; }
        .modal-content { background: white; margin: 20px auto; padding: 0; width: 90%; max-width: 600px; border-radius: 15px; animation: slideDown 0.3s; }
        .modal-header { background: linear-gradient(135deg, #1e3c72 0%, #dc143c 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .close-modal { font-size: 24px; color: white; cursor: pointer; background: none; border: none; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Booking Calendar */
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin: 15px 0; }
        .calendar-header { grid-column: 1 / -1; text-align: center; font-weight: 600; margin-bottom: 10px; }
        .calendar-day { padding: 8px; text-align: center; cursor: pointer; border-radius: 5px; transition: all 0.3s; }
        .calendar-day:hover { background: #f0f0f0; }
        .calendar-day.selected { background: #dc143c; color: white; }
        .calendar-day.disabled { color: #ccc; cursor: not-allowed; }
        
        /* Time Slots */
        .time-slots { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin: 15px 0; }
        .time-slot { padding: 8px; text-align: center; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .time-slot:hover { background: #f0f0f0; }
        .time-slot.selected { background: #dc143c; color: white; border-color: #dc143c; }
        .time-slot.disabled { color: #ccc; cursor: not-allowed; }
        
        /* Form Styles */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #1e3c72; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ù D·ªãch V·ª•</h1>
            <p>K·∫øt n·ªëi d·ªãch v·ª• t·ª´ c·ªông ƒë·ªìng ng∆∞·ªùi Vi·ªát</p>
        </header>

        <nav>
            <div class="nav-wrapper">
                <button class="nav-toggle" onclick="toggleNav()">‚ò∞</button>
                <div class="nav-links" id="navLinks">
                    <a href="index.html">üè† Trang Ch·ªß</a>
                    <a href="marketplace.html">üè™ Mua B√°n</a>
                    <a href="jobs.html">üíº Vi·ªác L√†m</a>
                    <a href="services.html" class="active">ü§ù D·ªãch V·ª•</a>
                    <a href="food.html">üçú ·∫®m Th·ª±c</a>
                    <a href="realestate.html">üè† B·∫•t ƒê·ªông S·∫£n</a>
                    <a href="classifieds.html">üì∞ Rao V·∫∑t</a>
                </div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userName">User</span>
                    <button class="logout-btn" onclick="logout()">ƒêƒÉng Xu·∫•t</button>
                </div>
            </div>
        </nav>

        <div class="main-content">
            <div class="actions-bar">
                <div class="search-filter-row">
                    <input type="text" class="search-box" id="searchBox" placeholder="üîç T√¨m ki·∫øm d·ªãch v·ª•..." oninput="debounceSearch()">
                    <select id="typeFilter" class="search-box">
                        <option value="">T·∫•t c·∫£ lo·∫°i d·ªãch v·ª•</option>
                        <option value="nail">Nail & Spa</option>
                        <option value="hair">T√≥c & L√†m ƒë·∫πp</option>
                        <option value="repair">S·ª≠a ch·ªØa</option>
                        <option value="cleaning">V·ªá sinh & D·ªçn d·∫πp</option>
                        <option value="moving">Chuy·ªÉn nh√†</option>
                        <option value="tax">K·∫ø to√°n & Thu·∫ø</option>
                        <option value="legal">Lu·∫≠t & Di tr√∫</option>
                        <option value="education">Gi√°o d·ª•c & D·∫°y h·ªçc</option>
                        <option value="health">Y t·∫ø & S·ª©c kh·ªèe</option>
                        <option value="tech">IT & C√¥ng ngh·ªá</option>
                        <option value="other">Kh√°c</option>
                    </select>
                    <button class="filter-btn" onclick="showFilters()">üîß B·ªô L·ªçc</button>
                    <button class="post-btn" onclick="goToPost()">üìù ƒêƒÉng D·ªãch V·ª•</button>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <span>ƒêang t·∫£i...</span>
            </div>

            <div id="servicesGrid" class="services-grid" style="display: none;"></div>
        </div>

        <footer>
            <div class="footer-content">
                <div class="footer-column">
                    <h4>H·ªó Tr·ª£</h4>
                    <ul>
                        <li><a href="contact.html">Li√™n H·ªá</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>V·ªÅ VietLinker</h4>
                    <ul>
                        <li><a href="about.html">Gi·ªõi Thi·ªáu</a></li>
                        <li><a href="terms.html">ƒêi·ªÅu Kho·∫£n</a></li>
                        <li><a href="privacy.html">Ch√≠nh S√°ch B·∫£o M·∫≠t</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>D·ªãch V·ª•</h4>
                    <ul>
                        <li><a href="contact.html">Qu·∫£ng C√°o</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 VietLinker. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
            </div>
        </footer>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ÔøΩÔøΩ ƒê·∫∑t L·ªãch H·∫πn</h2>
                <button class="close-modal" onclick="closeBookingModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="bookingContent"></div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí¨ Nh·∫Øn Tin</h2>
                <button class="close-modal" onclick="closeChatModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="chatContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Performance optimizations
        let searchTimeout;
        let currentPage = 1;
        let itemsPerPage = 12;
        let allServices = [];
        let filteredServices = [];
        let currentUser = null;
        let favorites = new Set();
        let isLoading = false;
        let supabase = null;
        let selectedService = null;

        // Initialize Supabase properly
        async function initializeSupabase() {
            try {
                if (typeof window.supabase !== 'undefined') {
                    supabase = window.supabase;
                    return true;
                }

                let attempts = 0;
                while (attempts < 50) {
                    if (typeof window.supabase !== 'undefined') {
                        supabase = window.supabase;
                        return true;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (typeof createClient !== 'undefined') {
                    supabase = createClient(
                        'https://wwlmvcsozavqfvwlxkrt.supabase.co',
                        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3bG12Y3NvemF2cWZ2d2x4a3J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzI5NzAsImV4cCI6MjA1MDU0ODk3MH0.Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8'
                    );
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error initializing Supabase:', error);
                return false;
            }
        }

        // Debounced search
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterServices();
            }, 300);
        }

        // Initialize app
        async function initialize() {
            try {
                console.log('üöÄ VietLinker Services Starting...');
                
                const supabaseReady = await initializeSupabase();
                if (!supabaseReady) {
                    throw new Error('Supabase not available');
                }
                
                checkAuth().then(() => {
                    if (currentUser) {
                        loadFavorites();
                    }
                });
                
                await loadServices();
                
                console.log('‚úÖ VietLinker Services Ready!');
            } catch (error) {
                console.error('‚ùå Error initializing:', error);
                showError('C√≥ l·ªói x·∫£y ra khi t·∫£i trang. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // Auth check
        async function checkAuth() {
            if (!supabase) return;

            try {
                const { data: { session } } = await supabase.auth.getSession();
                currentUser = session?.user || null;
                
                const userInfo = document.getElementById('userInfo');
                const userName = document.getElementById('userName');
                
                if (currentUser) {
                    userName.textContent = currentUser.email || 'User';
                    userInfo.style.display = 'flex';
                } else {
                    userInfo.style.display = 'none';
                }
            } catch (error) {
                console.warn('Auth check warning:', error);
            }
        }

        // Load services
        async function loadServices() {
            if (isLoading) return;
            
            isLoading = true;
            const loading = document.getElementById('loading');
            const servicesGrid = document.getElementById('servicesGrid');
            
            loading.style.display = 'flex';
            servicesGrid.style.display = 'none';

            try {
                if (!supabase) throw new Error('Supabase not available');

                const { data, error } = await supabase
                    .from('services')
                    .select('*')
                    .eq('status', 'active')
                    .order('created_at', { ascending: false })
                    .limit(100);

                if (error) throw error;

                allServices = data || [];
                filteredServices = [...allServices];
                
                renderServices();
                
            } catch (error) {
                console.error('Error loading services:', error);
                showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch d·ªãch v·ª•. Vui l√≤ng th·ª≠ l·∫°i.');
            } finally {
                loading.style.display = 'none';
                isLoading = false;
            }
        }

        // Render services
        function renderServices() {
            const servicesGrid = document.getElementById('servicesGrid');
            
            if (filteredServices.length === 0) {
                servicesGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Kh√¥ng t√¨m th·∫•y d·ªãch v·ª• n√†o.</div>';
                servicesGrid.style.display = 'block';
                return;
            }

            const serviceTypes = {
                'nail': 'Nail & Spa',
                'hair': 'T√≥c & L√†m ƒë·∫πp',
                'repair': 'S·ª≠a ch·ªØa',
                'cleaning': 'V·ªá sinh & D·ªçn d·∫πp',
                'moving': 'Chuy·ªÉn nh√†',
                'tax': 'K·∫ø to√°n & Thu·∫ø',
                'legal': 'Lu·∫≠t & Di tr√∫',
                'education': 'Gi√°o d·ª•c & D·∫°y h·ªçc',
                'health': 'Y t·∫ø & S·ª©c kh·ªèe',
                'tech': 'IT & C√¥ng ngh·ªá',
                'other': 'Kh√°c'
            };

            const servicesHTML = filteredServices.map((service, index) => {
                const typeDisplay = serviceTypes[service.service_type] || service.service_type;
                const locationInfo = [service.city, service.zipcode].filter(Boolean).join(', ');
                const experienceText = service.experience ? `${service.experience} nƒÉm kinh nghi·ªám` : '';

                return `
                    <div class="service-card" data-service-index="${index}">
                        ${service.experience ? `<div class="experience-badge">‚≠ê ${experienceText}</div>` : ''}
                        <img src="${escapeHtml(service.image_url || '')}" 
                             alt="${escapeHtml(service.title)}" 
                             class="service-image"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7DgW5oIGNo4bqldSB0w6A8L3RleHQ+Cjwvc3ZnPgo='"
                             loading="lazy">
                        <div class="service-content">
                            <div class="service-title">${escapeHtml(service.title)}</div>
                            <div class="service-type">${escapeHtml(typeDisplay)}</div>
                            <div class="service-description">${escapeHtml(service.description)}</div>
                            <div class="service-details">
                                ${service.price ? `<div class="service-detail-item">üíµ ${escapeHtml(service.price)}</div>` : ''}
                                ${service.location ? `<div class="service-detail-item">üìç ${escapeHtml(service.location)}</div>` : ''}
                                ${locationInfo ? `<div class="service-detail-item">üèôÔ∏è ${escapeHtml(locationInfo)}</div>` : ''}
                                <div class="service-detail-item">üìû ${escapeHtml(service.contact)}</div>
                                <div class="service-detail-item">üëÅÔ∏è ${service.views || 0} l∆∞·ª£t xem</div>
                            </div>
                            <div class="service-actions">
                                <button class="action-btn book-btn" onclick="event.stopPropagation(); openBooking(${index})">ÔøΩÔøΩ ƒê·∫∑t l·ªãch</button>
                                <button class="action-btn chat-btn" onclick="event.stopPropagation(); openChat(${index})">ÔøΩÔøΩ Nh·∫Øn tin</button>
                                <button class="action-btn share-btn" onclick="event.stopPropagation(); shareService(${index})">üì§ Chia s·∫ª</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            servicesGrid.innerHTML = servicesHTML;
            servicesGrid.style.display = 'block';
            
            // Add click handlers
            const serviceCards = servicesGrid.querySelectorAll('.service-card');
            serviceCards.forEach((card, index) => {
                card.onclick = () => viewServiceDetail(index);
            });
        }

        // Filter services
        function filterServices() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const typeFilter = document.getElementById('typeFilter').value;
            
            filteredServices = allServices.filter(service => {
                const matchesSearch = !searchTerm || 
                    service.title?.toLowerCase().includes(searchTerm) ||
                    service.description?.toLowerCase().includes(searchTerm) ||
                    service.city?.toLowerCase().includes(searchTerm);
                
                const matchesType = !typeFilter || service.service_type === typeFilter;
                
                return matchesSearch && matchesType;
            });

            renderServices();
        }

        // Booking system
        function openBooking(serviceIndex) {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t l·ªãch!');
                return;
            }

            selectedService = allServices[serviceIndex];
            const modal = document.getElementById('bookingModal');
            const content = document.getElementById('bookingContent');
            
            const calendar = generateCalendar();
            const timeSlots = generateTimeSlots();
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3>${escapeHtml(selectedService.title)}</h3>
                    <p>${escapeHtml(selectedService.description)}</p>
                </div>
                <div class="form-group">
                    <label>Ch·ªçn ng√†y:</label>
                    ${calendar}
                </div>
                <div class="form-group">
                    <label>Ch·ªçn gi·ªù:</label>
                    ${timeSlots}
                </div>
                <div class="form-group">
                    <label>Ghi ch√∫:</label>
                    <textarea id="bookingNote" placeholder="Ghi ch√∫ cho cu·ªôc h·∫πn..." rows="3"></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button class="action-btn" onclick="closeBookingModal()">H·ªßy</button>
                    <button class="action-btn book-btn" onclick="submitBooking()">X√°c nh·∫≠n ƒë·∫∑t l·ªãch</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function generateCalendar() {
            const today = new Date();
            const days = [];
            
            for (let i = 0; i < 14; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                days.push(date);
            }
            
            return `
                <div class="calendar">
                    <div class="calendar-header">Ch·ªçn ng√†y trong 2 tu·∫ßn t·ªõi</div>
                    ${days.map((date, index) => `
                        <div class="calendar-day" onclick="selectDate(${index})" data-date="${date.toISOString().split('T')[0]}">
                            ${date.getDate()}/${date.getMonth() + 1}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function generateTimeSlots() {
            const slots = ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'];
            return `
                <div class="time-slots">
                    ${slots.map(slot => `
                        <div class="time-slot" onclick="selectTime('${slot}')" data-time="${slot}">
                            ${slot}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        let selectedDate = null;
        let selectedTime = null;

        function selectDate(index) {
            document.querySelectorAll('.calendar-day').forEach(day => day.classList.remove('selected'));
            event.target.classList.add('selected');
            selectedDate = event.target.dataset.date;
        }

        function selectTime(time) {
            document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
            event.target.classList.add('selected');
            selectedTime = time;
        }

        async function submitBooking() {
            if (!selectedDate || !selectedTime) {
                alert('Vui l√≤ng ch·ªçn ng√†y v√† gi·ªù!');
                return;
            }

            try {
                const bookingData = {
                    user_id: currentUser.id,
                    service_id: selectedService.id,
                    service_provider_id: selectedService.user_id,
                    booking_date: selectedDate,
                    booking_time: selectedTime,
                    note: document.getElementById('bookingNote').value,
                    status: 'pending',
                    created_at: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('bookings')
                    .insert([bookingData]);

                if (error) throw error;

                alert('ƒê·∫∑t l·ªãch th√†nh c√¥ng! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá s·ªõm nh·∫•t.');
                closeBookingModal();
                
                // Send notification
                sendNotification(selectedService.user_id, 'C√≥ ƒë·∫∑t l·ªãch m·ªõi!');
                
            } catch (error) {
                console.error('Booking error:', error);
                alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // Chat system
        function openChat(serviceIndex) {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ nh·∫Øn tin!');
                return;
            }

            selectedService = allServices[serviceIndex];
            const modal = document.getElementById('chatModal');
            const content = document.getElementById('chatContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3>Nh·∫Øn tin v·ªõi: ${escapeHtml(selectedService.title)}</h3>
                </div>
                <div id="chatMessages" style="height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; background: #f9f9f9;">
                    <div style="text-align: center; color: #666;">B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán...</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <button class="action-btn chat-btn" onclick="sendMessage()">G·ª≠i</button>
                </div>
            `;
            
            modal.style.display = 'block';
            loadChatMessages();
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;

            try {
                const messageData = {
                    sender_id: currentUser.id,
                    receiver_id: selectedService.user_id,
                    service_id: selectedService.id,
                    message: message,
                    created_at: new Date().toISOString()
                };

                const { error } = await supabase
                    .from('messages')
                    .insert([messageData]);

                if (error) throw error;

                messageInput.value = '';
                loadChatMessages();
                
            } catch (error) {
                console.error('Message error:', error);
                alert('Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        async function loadChatMessages() {
            try {
                const { data, error } = await supabase
                    .from('messages')
                    .select('*')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedService.user_id}),and(sender_id.eq.${selectedService.user_id},receiver_id.eq.${currentUser.id})`)
                    .eq('service_id', selectedService.id)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                const messagesDiv = document.getElementById('chatMessages');
                if (!messagesDiv) return;

                const messagesHTML = data.map(msg => `
                    <div style="margin-bottom: 10px; text-align: ${msg.sender_id === currentUser.id ? 'right' : 'left'};">
                        <div style="display: inline-block; max-width: 70%; padding: 8px 12px; border-radius: 15px; background: ${msg.sender_id === currentUser.id ? '#dc143c' : 'white'}; color: ${msg.sender_id === currentUser.id ? 'white' : 'black'}; border: 1px solid #ddd;">
                            ${escapeHtml(msg.message)}
                        </div>
                    </div>
                `).join('');

                messagesDiv.innerHTML = messagesHTML;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
            } catch (error) {
                console.error('Load messages error:', error);
            }
        }

        // Social sharing
        function shareService(serviceIndex) {
            const service = allServices[serviceIndex];
            const shareText = `D·ªãch v·ª•: ${service.title} - ${service.description}`;
            const shareUrl = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: 'VietLinker - D·ªãch v·ª•',
                    text: shareText,
                    url: shareUrl
                });
            } else {
                // Fallback for older browsers
                const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}&quote=${encodeURIComponent(shareText)}`;
                window.open(url, '_blank');
            }
        }

        // Notifications
        async function sendNotification(userId, message) {
            try {
                const notificationData = {
                    user_id: userId,
                    message: message,
                    type: 'booking',
                    read: false,
                    created_at: new Date().toISOString()
                };

                await supabase
                    .from('notifications')
                    .insert([notificationData]);

            } catch (error) {
                console.error('Notification error:', error);
            }
        }

        // Utility functions
        function viewServiceDetail(serviceIndex) {
            const service = allServices[serviceIndex];
            updateViewCount(service.id);
            alert(`Chi ti·∫øt d·ªãch v·ª•: ${service.title}`);
        }

        async function updateViewCount(serviceId) {
            try {
                const { data } = await supabase
                    .from('services')
                    .select('views')
                    .eq('id', serviceId)
                    .single();

                const newViews = (data?.views || 0) + 1;
                
                await supabase
                    .from('services')
                    .update({ views: newViews })
                    .eq('id', serviceId);

            } catch (error) {
                console.error('Update view count error:', error);
            }
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').style.display = 'none';
            selectedService = null;
            selectedDate = null;
            selectedTime = null;
        }

        function closeChatModal() {
            document.getElementById('chatModal').style.display = 'none';
            selectedService = null;
        }

        function toggleNav() {
            const navLinks = document.getElementById('navLinks');
            navLinks.classList.toggle('active');
        }

        async function logout() {
            try {
                await supabase.auth.signOut();
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function goToPost() {
            window.location.href = 'post-form.html';
        }

        function showFilters() {
            alert('T√≠nh nƒÉng b·ªô l·ªçc n√¢ng cao s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t s·ªõm!');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            const servicesGrid = document.getElementById('servicesGrid');
            servicesGrid.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc143c;">${message}</div>`;
            servicesGrid.style.display = 'block';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
