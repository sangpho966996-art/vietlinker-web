<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Rao Vặt - VietLinker</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; background: #fff; }
    header { background: linear-gradient(135deg, #1e3c72 0%, #dc143c 100%); color: #fff; padding: 14px 16px; position:relative; overflow:hidden; }
    header::before { content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background: radial-gradient(circle, rgba(255,255,255,0.12) 0%, transparent 60%); animation: shimmer 6s linear infinite; }
    @keyframes shimmer { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .logo-text { font-weight: 800; font-size: 22px; }
    .header-row { max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px; position:relative; z-index:1; }
    .user-actions { display:flex; align-items:center; gap:10px; }
    .btn-post { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color:#fff; text-decoration:none; padding:8px 14px; border-radius:999px; font-weight:700; }
    .auth-buttons a { background: rgba(255,255,255,0.15); color:#fff; text-decoration:none; padding:8px 12px; border-radius:10px; }
    .auth-buttons.hidden { display:none; }
    .user-info { display:none; align-items:center; gap:8px; }
    .user-info.active { display:flex; }
    .user-avatar { width:34px; height:34px; border-radius:50%; background:#FFD700; color:#1e3c72; display:flex; align-items:center; justify-content:center; font-weight:800; }
    .user-name { font-weight:600; }
    /* Hero Search Section (match index.html style) */
    .hero-search { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding: 40px 20px; position: relative; overflow: hidden; }
    .hero-search::before { content:''; position:absolute; inset:0; background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat; }
    .search-container { max-width: 1000px; margin: 0 auto; text-align: center; position: relative; z-index: 1; }
    .search-title { color:#fff; font-size:32px; font-weight:800; margin-bottom:10px; text-shadow:0 2px 10px rgba(0,0,0,0.2); }
    .search-subtitle { color:rgba(255,255,255,0.9); font-size:16px; margin-bottom:20px; }
    .mega-search-box { background:#fff; border-radius:15px; padding:20px; box-shadow:0 15px 50px rgba(0,0,0,0.25); display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .search-input-group { flex:1; min-width:180px; position:relative; }
    .search-input-group input, .search-input-group select { width:100%; padding:12px 15px 12px 40px; border:2px solid #e0e0e0; border-radius:10px; font-size:15px; background:#fff; }
    .search-input-group input:focus, .search-input-group select:focus { outline:none; border-color:#dc143c; box-shadow:0 0 0 3px rgba(220,20,60,0.1); }
    .search-input-group .input-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); font-size:18px; color:#666; }
    .search-btn-primary { background: linear-gradient(135deg, #dc143c 0%, #b91c3c 100%); color:#fff; border:none; padding:14px 24px; border-radius:10px; font-weight:800; cursor:pointer; box-shadow:0 6px 20px rgba(220,20,60,0.3); }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .loading { text-align: center; padding: 40px; color: #666; }
    .empty { text-align: center; padding: 60px 16px; color: #999; }

    /* Nav */
    nav { background:#1e3c72; position:sticky; top:0; z-index:30; border-bottom:3px solid rgba(220,20,60,0.25); box-shadow:0 2px 14px rgba(0,0,0,0.12); }
    .nav-links { display:flex; gap:8px; padding:10px 0; overflow:auto; }
    .nav-links a { color:#fff; text-decoration:none; padding:8px 12px; border-radius:10px; white-space:nowrap; font-weight:500; }
    .nav-links a.active { background:linear-gradient(135deg, #dc143c, #b91c3c); }

    .btn-primary { background: linear-gradient(135deg, #dc143c 0%, #b91c3c 100%); color:#fff; border:none; border-radius:10px; padding:12px 18px; font-weight:700; cursor:pointer; }

    /* Filter pills */
    .filters { margin-top:16px; display:flex; gap:8px; overflow:auto; padding-bottom:8px; }
    .pill { border:1px solid #e5e7eb; background:#f8fafc; color:#374151; padding:8px 14px; border-radius:999px; cursor:pointer; white-space:nowrap; }
    .pill.active { background:linear-gradient(135deg, #dc143c 0%, #b91c3c 100%); color:#fff; border-color:#dc143c; box-shadow:0 4px 10px rgba(220,20,60,0.25); }

    /* Grid */
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; margin-top:16px; }
    @media (max-width: 1024px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } .search-row { grid-template-columns: 1fr; } }

    .card { border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.06); cursor:pointer; position:relative; }
    .card::before { content:''; position:absolute; left:0; right:0; top:0; height:4px; background:linear-gradient(90deg, #dc143c, #FFD700, #1e3c72); transform:scaleX(0); transform-origin:left; transition:transform .25s ease; }
    .card:hover::before { transform:scaleX(1); }
    .card .thumb { height:180px; background:linear-gradient(135deg, rgba(220,20,60,0.08), rgba(30,60,114,0.08)); display:flex; align-items:center; justify-content:center; font-size:42px; position:relative; }
    .card .thumb img { width:100%; height:100%; object-fit:cover; }
    .badge { position:absolute; left:10px; top:10px; background:#dc143c; color:#fff; padding:4px 10px; border-radius:999px; font-size:12px; }
    .price { position:absolute; right:10px; bottom:10px; background:#FFD700; color:#1e3c72; padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px; }
    .card .body { padding:12px; }
    .title { font-weight:700; color:#1e3c72; margin-bottom:6px; }
    .desc { color:#6b7280; font-size:14px; height:42px; overflow:hidden; }
    .meta { display:flex; gap:12px; color:#9ca3af; font-size:12px; margin-top:8px; }
    .qa { display:grid; grid-template-columns: repeat(3,1fr); gap:8px; margin-top:10px; }
    .qa button { border:none; border-radius:8px; padding:8px; background:#f3f4f6; color:#374151; cursor:pointer; }

    /* Floating button */
    .fab { position:fixed; right:20px; bottom:20px; width:56px; height:56px; border-radius:50%; background: linear-gradient(135deg, #dc143c 0%, #b91c3c 100%); color:#fff; border:none; font-size:24px; cursor:pointer; box-shadow:0 8px 24px rgba(220,20,60,0.35); }

    /* Modal */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; }
    .modal .content { position:absolute; left:50%; top:50%; transform:translate(-50%, -50%); background:#fff; width:92%; max-width:720px; max-height:92vh; border-radius:16px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.25); }
    .modal .head { background: linear-gradient(135deg, #1e3c72 0%, #dc143c 100%); color:#fff; padding:14px 16px; display:flex; align-items:center; justify-content:space-between; }
    .modal .body { padding:16px; max-height: calc(92vh - 60px); overflow:auto; }
    .close { background:none; border:none; font-size:26px; color:#fff; cursor:pointer; }

    /* Form */
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 640px) { .row { grid-template-columns: 1fr; } }
    .form-group { margin-bottom:12px; }
    .form-group label { display:block; font-weight:600; color:#1e3c72; margin-bottom:6px; }
    .form-group input, .form-group textarea, .form-group select { width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#f9fafb; }
    .submit { width:100%; padding:12px; background: linear-gradient(135deg, #dc143c 0%, #b91c3c 100%); border:none; color:#fff; border-radius:12px; font-weight:700; cursor:pointer; }

    /* Upload */
    .upload { border:2px dashed #dc143c; border-radius:12px; padding:20px; text-align:center; cursor:pointer; background:linear-gradient(135deg, rgba(220,20,60,0.05), rgba(30,60,114,0.05)); }
    .preview { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:10px; }
    .preview-item { position:relative; border-radius:8px; overflow:hidden; aspect-ratio:1; background:#eee; }
    .preview-item img { width:100%; height:100%; object-fit:cover; }
    .rm { position:absolute; right:6px; top:6px; width:22px; height:22px; border:none; border-radius:50%; background:#dc3545; color:#fff; cursor:pointer; }
  </style>
  </style>
</head>
<body>
  <header>
    <div class="header-row">
      <span style="display:flex;align-items:center;gap:10px;">
        <svg viewBox="0 0 100 100" width="42" height="42" aria-hidden="true">
          <circle cx="50" cy="50" r="45" fill="white" opacity="0.95"/>
          <circle cx="50" cy="25" r="8" fill="#dc143c"/>
          <circle cx="25" cy="50" r="8" fill="#FFD700"/>
          <circle cx="75" cy="50" r="8" fill="#FFD700"/>
          <circle cx="50" cy="75" r="8" fill="#1e3c72"/>
          <line x1="50" y1="25" x2="25" y2="50" stroke="#dc143c" stroke-width="2" opacity="0.5"/>
          <line x1="50" y1="25" x2="75" y2="50" stroke="#dc143c" stroke-width="2" opacity="0.5"/>
          <line x1="25" y1="50" x2="50" y2="75" stroke="#FFD700" stroke-width="2" opacity="0.5"/>
          <line x1="75" y1="50" x2="50" y2="75" stroke="#FFD700" stroke-width="2" opacity="0.5"/>
        </svg>
        <span class="logo-text">VietLinker • Rao Vặt</span>
      </span>
      <div class="user-actions">
        <a href="#" class="btn-post" id="postNow">✍️ Đăng tin</a>
        <div class="user-info" id="userInfo">
          <div class="user-avatar" id="userAvatar">U</div>
          <span class="user-name" id="userName">User</span>
        </div>
        <div class="auth-buttons" id="authButtons">
          <a href="login.html">Đăng nhập</a>
          <a href="register.html">Đăng ký</a>
        </div>
      </div>
    </div>
  </header>

  <nav>
    <div class="container">
      <div class="nav-links">
        <a href="index.html">🏠 Trang Chủ</a>
        <a href="marketplace.html">🛒 Mua Bán</a>
        <a href="jobs.html">💼 Việc Làm</a>
        <a href="services.html">🤝 Dịch Vụ</a>
        <a href="food.html">🍜 Ăn Uống</a>
        <a href="realestate.html">🏠 BĐS & Tiệm</a>
        <a href="classifieds.html" class="active">📋 Rao Vặt</a>
        <a href="promotions.html">🎁 Khuyến Mãi</a>
      </div>
    </div>
  </nav>

  <section class="hero-search">
    <div class="search-container">
      <h1 class="search-title">📢 Rao Vặt Cộng Đồng</h1>
      <p class="search-subtitle">Tìm kiếm • Đăng tin • Kết nối trong cộng đồng người Việt</p>
      <div class="mega-search-box">
        <div class="search-input-group">
          <span class="input-icon">🔍</span>
          <input type="text" id="searchInput" placeholder="Tìm gì? (VD: iPhone, xe đạp, thú cưng...)" />
        </div>
        <div class="search-input-group">
          <span class="input-icon">📍</span>
          <input type="text" id="locationInput" placeholder="Zipcode hoặc Thành phố" />
        </div>
        <div class="search-input-group">
          <span class="input-icon">📂</span>
          <select id="categoryFilter">
            <option value="">Tất cả danh mục</option>
            <option value="vehicle">🚗 Xe cộ</option>
            <option value="electronics">📱 Điện tử</option>
            <option value="furniture">🪑 Nội thất</option>
            <option value="clothes">👕 Quần áo</option>
            <option value="baby">👶 Mẹ & Bé</option>
            <option value="pet">🐕 Thú cưng</option>
            <option value="books">📚 Sách báo</option>
            <option value="sports">⚽ Thể thao</option>
            <option value="tools">🔧 Dụng cụ</option>
            <option value="other">📦 Khác</option>
          </select>
        </div>
        <button class="search-btn-primary" id="searchBtn">🔍 TÌM KIẾM</button>
      </div>
    </div>
  </section>

  <!-- Quick Stats -->
  <div class="container" id="quickStats" style="margin-top:12px;">
    <div class="stats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
      <div class="stat" style="border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:14px;text-align:center;">
        <div style="font-size:24px;font-weight:800;color:#b91c3c" id="totalCount">0</div>
        <div style="color:#6b7280;font-size:13px">Tổng tin rao vặt</div>
      </div>
      <div class="stat" style="border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:14px;text-align:center;">
        <div style="font-size:24px;font-weight:800;color:#b91c3c" id="todayCount">0</div>
        <div style="color:#6b7280;font-size:13px">Tin mới hôm nay</div>
      </div>
      <div class="stat" style="border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:14px;text-align:center;">
        <div style="font-size:24px;font-weight:800;color:#b91c3c" id="activeCount">0</div>
        <div style="color:#6b7280;font-size:13px">Đang hoạt động</div>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="filters" id="typeFilters">
      <button class="pill active" data-type="all">Tất cả</button>
      <button class="pill" data-type="sell">Cần bán</button>
      <button class="pill" data-type="buy">Cần mua</button>
      <button class="pill" data-type="trade">Trao đổi</button>
      <button class="pill" data-type="free">Cho tặng</button>
      <button class="pill" data-type="lost">Thất lạc</button>
      <button class="pill" data-type="found">Nhặt được</button>
    </div>

    <div id="classifiedsContainer" class="grid"></div>
  </main>

  <button class="fab" id="postBtn" title="Đăng tin">＋</button>

  <!-- Post Modal -->
  <div class="modal" id="postModal">
    <div class="content">
      <div class="head"><h3>📝 Đăng Tin Rao Vặt</h3><button class="close" data-close="postModal">×</button></div>
      <div class="body">
        <form id="classifiedForm">
          <div class="form-group"><label for="title">Tiêu đề *</label><input id="title" required /></div>
          <div class="row">
            <div class="form-group"><label for="type">Loại tin *</label>
              <select id="type" required>
                <option value="">Chọn</option>
                <option value="sell">Cần bán</option>
                <option value="buy">Cần mua</option>
                <option value="trade">Trao đổi</option>
                <option value="free">Cho tặng</option>
                <option value="lost">Thất lạc</option>
                <option value="found">Nhặt được</option>
              </select>
            </div>
            <div class="form-group"><label for="category">Danh mục *</label>
              <select id="category" required>
                <option value="">Chọn</option>
                <option value="vehicle">Xe cộ</option>
                <option value="electronics">Điện tử</option>
                <option value="furniture">Nội thất</option>
                <option value="clothes">Quần áo</option>
                <option value="baby">Mẹ & Bé</option>
                <option value="pet">Thú cưng</option>
                <option value="books">Sách báo</option>
                <option value="sports">Thể thao</option>
                <option value="tools">Dụng cụ</option>
                <option value="other">Khác</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label for="price">Giá</label><input id="price" placeholder="VD: $500 hoặc Miễn phí" /></div>
          <div class="form-group"><label for="description">Mô tả *</label><textarea id="description" required></textarea></div>
          <div class="row">
            <div class="form-group"><label for="city">Thành phố *</label><input id="city" required /></div>
            <div class="form-group"><label for="zipcode">Zipcode *</label><input id="zipcode" required maxlength="5" pattern="[0-9]{5}" /></div>
          </div>
          <div class="form-group"><label for="location">Địa chỉ</label><input id="location" /></div>
          <div class="form-group"><label for="contact">Số điện thoại *</label><input id="contact" required /></div>
          <div class="form-group">
            <div class="upload" id="uploadArea">📷 Kéo thả hoặc bấm để chọn ảnh</div>
            <input type="file" id="imageInput" accept="image/*" multiple style="display:none" />
            <div class="preview" id="uploadPreview"></div>
          </div>
          <button class="submit" type="submit">Đăng Tin Ngay</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="content">
      <div class="head"><h3>Chi Tiết Rao Vặt</h3><button class="close" data-close="detailModal">×</button></div>
      <div class="body">
        <div class="thumb" id="detailImage" style="height:260px;">📢</div>
        <div class="share-row" style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn-primary" id="shareFb">📘 Facebook</button>
          <button class="btn-primary" id="shareZalo">💬 Zalo</button>
          <button class="btn-primary" id="shareCopy">🔗 Copy link</button>
        </div>
        <h2 class="title" id="detailTitle" style="margin-top:12px;"></h2>
        <div id="detailPrice" style="font-weight:800;color:#b91c3c;margin:6px 0 10px;"></div>
        <div id="detailBadges" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
        <div id="detailDescription" class="desc" style="white-space:pre-wrap;margin-top:12px;"></div>
        <div class="meta" style="margin-top:12px;">
          <span id="detailLocation"></span>
          <span id="detailDate"></span>
          <span id="detailViews"></span>
        </div>
        <div style="display:flex; gap:10px; margin-top:16px;">
          <button class="btn-primary" id="callBtn">📞 Gọi</button>
          <button class="btn-primary" id="smsBtn">💬 SMS</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <script>
    // Core globals
    window.supabaseClient = null;
    window.currentUser = null;
    window.allClassifieds = [];
    window.selectedFiles = [];

    const SUPABASE_URL = 'https://wwlmvcsozavqfvwlxkrt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3bG12Y3NvemF2cWZ2d2x4a3J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzUyMTMsImV4cCI6MjA2OTk1MTIxM30.HdxvLlqJgdntVUQDVtVlkjJJa7bn9CoIVUG8yn3WkLQ';

    // FIX: helper to always return a ready supabase client
    function getSupabase() {
      if (window.supabaseClient) return window.supabaseClient;
      const supabaseLib = window.supabase || window.Supabase;
      if (supabaseLib && typeof supabaseLib.createClient === 'function') {
        try {
          window.supabaseClient = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          return window.supabaseClient;
        } catch (e) {
          console.error('Error creating Supabase client:', e);
          return null;
        }
      }
      return null;
    }

    // Optional: guard to avoid multiple inits
    let appInitialized = false;
    function initializeApp() {
      if (appInitialized) return; appInitialized = true;
      const sb = getSupabase();
      if (!sb) {
        document.getElementById('classifiedsContainer').innerHTML = '<div class="empty">Không thể tải Supabase. Vui lòng refresh.</div>';
        return;
      }
      setupEvents();
      checkAuth();
      loadClassifieds();
      loadStats();
    }

    async function checkAuth() {
      const sb = getSupabase();
      if (!sb) return;
      try {
        const { data: { session } } = await sb.auth.getSession();
        window.currentUser = session?.user || null;
        sb.auth.onAuthStateChange((_e, sess) => { window.currentUser = sess?.user || null; });
      } catch {}
    }

    async function loadClassifieds() {
      const container = document.getElementById('classifiedsContainer');
      container.innerHTML = '<div class="loading">Đang tải tin rao vặt...</div>';
      const sb = getSupabase();
      if (!sb) { container.innerHTML = '<div class="empty">Không thể kết nối database</div>'; return; }
      try {
        const { data, error } = await sb
          .from('classifieds')
          .select('*')
          .eq('status', 'active')
          .order('created_at', { ascending: false });
        if (error) throw error;
        window.allClassifieds = data || [];
        renderClassifieds(window.allClassifieds);
      } catch (err) {
        console.error(err);
        container.innerHTML = '<div class="empty">Lỗi khi tải dữ liệu</div>';
      }
    }

    function renderClassifieds(list) {
      const container = document.getElementById('classifiedsContainer');
      if (!list || list.length === 0) { container.innerHTML = '<div class="empty">Chưa có tin rao vặt nào</div>'; return; }
      const typeLabels = { sell:'🏷️ Cần bán', buy:'🛒 Cần mua', trade:'🔄 Trao đổi', free:'🎁 Cho tặng', lost:'😢 Thất lạc', found:'😊 Nhặt được' };
      container.innerHTML = list.map((x, i) => `
        <div class="card" data-index="${i}">
          <div class="thumb">
            ${x.image_url ? `<img src="${x.image_url}" alt="${x.title}">` : '📢'}
            <span class="badge">${typeLabels[x.type] || x.type || ''}</span>
            ${x.price ? `<span class="price">${x.price}</span>` : ''}
          </div>
          <div class="body">
            <div class="title">${x.title || 'Không có tiêu đề'}</div>
            <div class="desc">${x.description || ''}</div>
            <div class="meta">
              <span>📍 ${x.city || ''}</span>
              <span>👁️ ${x.views || 0}</span>
              <span>📅 ${formatDate(x.created_at)}</span>
            </div>
            <div class="qa">
              <button data-act="call" data-phone="${x.contact || ''}">📞 Gọi</button>
              <button data-act="sms" data-phone="${x.contact || ''}" data-title="${(x.title||'').replace(/"/g,'&quot;')}">💬 SMS</button>
              <button data-act="share" data-title="${(x.title||'').replace(/"/g,'&quot;')}">🔗 Chia sẻ</button>
            </div>
          </div>
        </div>
      `).join('');
      // attach click
      container.querySelectorAll('.card').forEach(el => el.addEventListener('click', () => {
        const idx = Number(el.getAttribute('data-index'));
        viewDetail(idx);
      }));
      // quick actions
      container.querySelectorAll('.qa button').forEach(btn => btn.addEventListener('click', ev => {
        ev.stopPropagation();
        const act = btn.getAttribute('data-act');
        if (act === 'call') { const p = btn.getAttribute('data-phone'); if (p) window.location.href = `tel:${p}`; }
        if (act === 'sms') { const p = btn.getAttribute('data-phone'); const t = btn.getAttribute('data-title'); if (p) window.location.href = `sms:${p}?body=${encodeURIComponent('Quan tâm: ' + (t||''))}`; }
        if (act === 'share') { const t = btn.getAttribute('data-title'); if (navigator.share) navigator.share({ title: t, text: 'Xem tin rao vặt: ' + t, url: window.location.href }); else copyLink(); }
      }));
    }

    function setupEvents() {
      // search
      document.getElementById('searchBtn').addEventListener('click', applyFilters);
      document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') applyFilters(); });
      // pills
      document.querySelectorAll('#typeFilters .pill').forEach(p => p.addEventListener('click', e => {
        document.querySelectorAll('#typeFilters .pill').forEach(x => x.classList.remove('active'));
        e.currentTarget.classList.add('active');
        applyFilters();
      }));
      // modals
      document.querySelectorAll('.close').forEach(btn => btn.addEventListener('click', () => closeModal(btn.getAttribute('data-close'))));
      // click outside to close
      document.addEventListener('click', (e) => {
        const modals = ['postModal','detailModal'];
        modals.forEach(id => { const m = document.getElementById(id); if (m && e.target === m) closeModal(id); });
      });
      document.getElementById('postBtn').addEventListener('click', showPostModal);
      const postNow = document.getElementById('postNow'); if (postNow) postNow.addEventListener('click', (e) => { e.preventDefault(); showPostModal(); });
      // upload
      const uploadArea = document.getElementById('uploadArea');
      const imageInput = document.getElementById('imageInput');
      if (uploadArea) {
        uploadArea.addEventListener('click', () => imageInput.click());
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); });
        uploadArea.addEventListener('drop', e => { e.preventDefault(); handleFileSelect(e.dataTransfer.files); });
      }
      if (imageInput) imageInput.addEventListener('change', e => handleFileSelect(e.target.files));
      // form
      const form = document.getElementById('classifiedForm');
      if (form) form.addEventListener('submit', handleSubmit);
    }

    async function applyFilters() {
      const sb = getSupabase(); if (!sb) return;
      const searchTerm = document.getElementById('searchInput').value.trim();
      const location = document.getElementById('locationInput').value.trim();
      const category = document.getElementById('categoryFilter').value;
      const activeType = document.querySelector('#typeFilters .pill.active')?.dataset.type || 'all';
      const container = document.getElementById('classifiedsContainer');
      container.innerHTML = '<div class="loading">Đang tìm kiếm...</div>';
      try {
        let q = sb.from('classifieds').select('*').eq('status','active').order('created_at',{ ascending:false });
        if (activeType && activeType !== 'all') q = q.eq('type', activeType);
        if (category) q = q.eq('category', category);
        if (searchTerm) q = q.or(`title.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%`);
        if (location) {
          if (/^\d{5}$/.test(location)) q = q.eq('zipcode', location); else q = q.ilike('city', `%${location}%`);
        }
        const { data, error } = await q;
        if (error) throw error;
        window.allClassifieds = data || [];
        renderClassifieds(window.allClassifieds);
      } catch (err) {
        console.error(err);
        container.innerHTML = '<div class="empty">Lỗi khi tìm kiếm</div>';
      }
    }

    async function loadStats() {
      const sb = getSupabase(); if (!sb) return;
      try {
        const today = new Date().toISOString().split('T')[0];
        const { count: total } = await sb.from('classifieds').select('*', { count: 'exact', head: true });
        const { count: todayCount } = await sb.from('classifieds').select('*', { count: 'exact', head: true }).gte('created_at', today);
        const { count: active } = await sb.from('classifieds').select('*', { count: 'exact', head: true }).eq('status', 'active');
        document.getElementById('totalCount').textContent = total || 0;
        document.getElementById('todayCount').textContent = todayCount || 0;
        document.getElementById('activeCount').textContent = active || 0;
      } catch (err) { console.warn('stats error', err); }
    }

    function handleFileSelect(fileList) {
      const files = Array.from(fileList || []);
      if (files.length > 5) { alert('Tối đa 5 hình ảnh'); return; }
      window.selectedFiles = [];
      for (const f of files) {
        if (!f.type.startsWith('image/')) { alert(`File ${f.name} không phải hình ảnh`); continue; }
        if (f.size > 5 * 1024 * 1024) { alert(`File ${f.name} quá lớn (>5MB)`); continue; }
        window.selectedFiles.push(f);
      }
      updatePreview();
    }

    function updatePreview() {
      const preview = document.getElementById('uploadPreview');
      if (!preview) return;
      preview.innerHTML = window.selectedFiles.map((f, i) => {
        const url = URL.createObjectURL(f);
        return `<div class="preview-item"><img src="${url}" alt="preview"><button class="rm" data-i="${i}">×</button></div>`;
      }).join('');
      preview.querySelectorAll('.rm').forEach(btn => btn.addEventListener('click', () => { removeImage(Number(btn.getAttribute('data-i'))); }));
    }

    function removeImage(i) {
      window.selectedFiles.splice(i, 1);
      updatePreview();
    }

    async function handleSubmit(e) {
      e.preventDefault();
      if (!currentUser) { if (confirm('Vui lòng đăng nhập để đăng tin. Chuyển đến trang đăng nhập?')) window.location.href = 'login.html'; return; }
      const sb = getSupabase(); if (!sb) { alert('Không thể kết nối database'); return; }
      const submit = e.target.querySelector('button[type="submit"]');
      submit.disabled = true; submit.textContent = 'Đang đăng...';
      try {
        let imageUrl = null;
        if (selectedFiles.length > 0) {
          const file = selectedFiles[0];
          const fileName = `classified_${Date.now()}_${Math.random().toString(36).slice(2)}.${file.name.split('.').pop()}`;
          const { error: upErr } = await sb.storage.from('marketplace').upload(`classifieds/${fileName}`, file);
          if (upErr) throw upErr;
          const { data: pub } = sb.storage.from('marketplace').getPublicUrl(`classifieds/${fileName}`);
          imageUrl = pub?.publicUrl || null;
        }
        const payload = {
          user_id: currentUser.id,
          title: document.getElementById('title').value,
          description: document.getElementById('description').value,
          type: document.getElementById('type').value,
          category: document.getElementById('category').value,
          price: document.getElementById('price').value,
          location: document.getElementById('location').value,
          city: document.getElementById('city').value,
          zipcode: document.getElementById('zipcode').value,
          contact: document.getElementById('contact').value,
          image_url: imageUrl,
          status: 'active',
          views: 0
        };
        const { error } = await sb.from('classifieds').insert([payload]);
        if (error) throw error;
        alert('Đăng tin thành công');
        closeModal('postModal'); e.target.reset(); selectedFiles = []; updatePreview();
        loadClassifieds();
      } catch (err) {
        console.error(err); alert('Lỗi: ' + (err?.message || 'Không rõ'));
      } finally {
        submit.disabled = false; submit.textContent = 'Đăng Tin Ngay';
      }
    }

    async function viewDetail(index) {
      const item = allClassifieds[index]; if (!item) return;
      const sb = getSupabase(); if (sb) { try { await sb.from('classifieds').update({ views: (item.views||0)+1 }).eq('id', item.id); } catch {} }
      document.getElementById('detailImage').innerHTML = item.image_url ? `<img src="${item.image_url}" alt="${item.title}">` : '📢';
      document.getElementById('detailTitle').textContent = item.title || '';
      document.getElementById('detailPrice').textContent = item.price || 'Liên hệ';
      document.getElementById('detailDescription').textContent = item.description || '';
      document.getElementById('detailLocation').textContent = `${item.city || ''}, ${item.zipcode || ''}`;
      document.getElementById('detailDate').textContent = formatDate(item.created_at);
      document.getElementById('detailViews').textContent = `${(item.views||0)+1} lượt xem`;
      document.getElementById('detailBadges').innerHTML = `<span class="pill">${item.type || ''}</span><span class="pill">${item.category || ''}</span>`;
      document.getElementById('callBtn').onclick = () => window.location.href = `tel:${item.contact}`;
      document.getElementById('smsBtn').onclick = () => window.location.href = `sms:${item.contact}?body=Quan tâm: ${encodeURIComponent(item.title||'')}`;
      openModal('detailModal');
      // share handlers
      const t = item.title || 'Rao vặt VietLinker';
      document.getElementById('shareFb').onclick = () => shareToFacebook(t);
      document.getElementById('shareZalo').onclick = () => shareToZalo();
      document.getElementById('shareCopy').onclick = () => copyLink();
    }

    function shareToFacebook(title) {
      const url = encodeURIComponent(window.location.href);
      const quote = encodeURIComponent(title);
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${quote}`, '_blank');
    }
    function shareToZalo() {
      const url = encodeURIComponent(window.location.href);
      window.open(`https://zalo.me/share?url=${url}`, '_blank');
    }
    function copyLink() {
      navigator.clipboard?.writeText(window.location.href).then(() => alert('Đã copy link!'));
    }

    function openModal(id) { const m = document.getElementById(id); if (m) m.style.display = 'block'; }
    function closeModal(id) { const m = document.getElementById(id); if (m) m.style.display = 'none'; }
    function showPostModal() { if (!currentUser) { if (confirm('Vui lòng đăng nhập để đăng tin. Chuyển đến trang đăng nhập?')) window.location.href='login.html'; return; } openModal('postModal'); }

    function formatDate(d) {
      const date = new Date(d); const now = new Date(); const diffM = Math.floor((now - date)/60000);
      if (diffM < 60) return `${diffM} phút trước`;
      if (diffM < 1440) return `${Math.floor(diffM/60)} giờ trước`;
      if (diffM < 43200) return `${Math.floor(diffM/1440)} ngày trước`;
      return date.toLocaleDateString('vi-VN');
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>

