<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Rao V·∫∑t - VietLinker</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; background: #fff; }
    header { background: linear-gradient(135deg, #1e3c72 0%, #dc143c 100%); color: #fff; padding: 14px 16px; }
    .logo-text { font-weight: 800; font-size: 22px; }
    .header-row { max-width:1200px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .user-actions { display:flex; align-items:center; gap:10px; }
    .btn-post { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color:#fff; text-decoration:none; padding:8px 14px; border-radius:999px; font-weight:700; }
    .auth-buttons a { background: rgba(255,255,255,0.15); color:#fff; text-decoration:none; padding:8px 12px; border-radius:10px; }
    .auth-buttons.hidden { display:none; }
    .user-info { display:none; align-items:center; gap:8px; }
    .user-info.active { display:flex; }
    .user-avatar { width:34px; height:34px; border-radius:50%; background:#FFD700; color:#1e3c72; display:flex; align-items:center; justify-content:center; font-weight:800; }
    .user-name { font-weight:600; }
    .hero { background: #1e3c72; color: #fff; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .loading { text-align: center; padding: 40px; color: #666; }
    .empty { text-align: center; padding: 60px 16px; color: #999; }

    /* Nav */
    nav { background:#1e3c72; position:sticky; top:0; z-index:30; border-bottom:3px solid rgba(220,20,60,0.25); }
    .nav-links { display:flex; gap:8px; padding:10px 0; overflow:auto; }
    .nav-links a { color:#fff; text-decoration:none; padding:8px 12px; border-radius:10px; white-space:nowrap; font-weight:500; }
    .nav-links a.active { background:linear-gradient(135deg, #dc143c, #b91c3c); }

    /* Search */
    .search-row { background:#fff; margin-top:-12px; padding:16px; border-radius:10px; box-shadow:0 6px 24px rgba(0,0,0,0.1); display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px; }
    .search-input { position:relative; }
    .search-input input, .search-input select { width:100%; padding:12px 12px 12px 36px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; }
    .search-input .icon { position:absolute; left:10px; top:50%; transform:translateY(-50%); opacity:0.6; }
    .btn-primary { background: linear-gradient(135deg, #dc143c 0%, #b91c3c 100%); color:#fff; border:none; border-radius:10px; padding:12px 18px; font-weight:700; cursor:pointer; }

    /* Filter pills */
    .filters { margin-top:16px; display:flex; gap:8px; overflow:auto; padding-bottom:8px; }
    .pill { border:1px solid #e5e7eb; background:#f8fafc; color:#374151; padding:8px 14px; border-radius:999px; cursor:pointer; white-space:nowrap; }
    .pill.active { background:#dc143c; color:#fff; border-color:#dc143c; }

    /* Grid */
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:16px; margin-top:16px; }
    @media (max-width: 1024px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } .search-row { grid-template-columns: 1fr; } }

    .card { border:1px solid #e5e7eb; border-radius:14px; overflow:hidden; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.06); cursor:pointer; }
    .card .thumb { height:180px; background:linear-gradient(135deg, rgba(220,20,60,0.08), rgba(30,60,114,0.08)); display:flex; align-items:center; justify-content:center; font-size:42px; position:relative; }
    .card .thumb img { width:100%; height:100%; object-fit:cover; }
    .badge { position:absolute; left:10px; top:10px; background:#dc143c; color:#fff; padding:4px 10px; border-radius:999px; font-size:12px; }
    .price { position:absolute; right:10px; bottom:10px; background:#FFD700; color:#1e3c72; padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px; }
    .card .body { padding:12px; }
    .title { font-weight:700; color:#1e3c72; margin-bottom:6px; }
    .desc { color:#6b7280; font-size:14px; height:42px; overflow:hidden; }
    .meta { display:flex; gap:12px; color:#9ca3af; font-size:12px; margin-top:8px; }
    .qa { display:grid; grid-template-columns: repeat(3,1fr); gap:8px; margin-top:10px; }
    .qa button { border:none; border-radius:8px; padding:8px; background:#f3f4f6; color:#374151; cursor:pointer; }

    /* Floating button */
    .fab { position:fixed; right:20px; bottom:20px; width:56px; height:56px; border-radius:50%; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color:#fff; border:none; font-size:24px; cursor:pointer; box-shadow:0 8px 24px rgba(0,0,0,0.2); }

    /* Modal */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; }
    .modal .content { position:absolute; left:50%; top:50%; transform:translate(-50%, -50%); background:#fff; width:92%; max-width:720px; max-height:92vh; border-radius:16px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.25); }
    .modal .head { background: linear-gradient(135deg, #1e3c72 0%, #dc143c 100%); color:#fff; padding:14px 16px; display:flex; align-items:center; justify-content:space-between; }
    .modal .body { padding:16px; max-height: calc(92vh - 60px); overflow:auto; }
    .close { background:none; border:none; font-size:26px; color:#fff; cursor:pointer; }

    /* Form */
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 640px) { .row { grid-template-columns: 1fr; } }
    .form-group { margin-bottom:12px; }
    .form-group label { display:block; font-weight:600; color:#1e3c72; margin-bottom:6px; }
    .form-group input, .form-group textarea, .form-group select { width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; background:#f9fafb; }
    .submit { width:100%; padding:12px; background: linear-gradient(135deg, #dc143c 0%, #b91c3c 100%); border:none; color:#fff; border-radius:12px; font-weight:700; cursor:pointer; }

    /* Upload */
    .upload { border:2px dashed #dc143c; border-radius:12px; padding:20px; text-align:center; cursor:pointer; background:linear-gradient(135deg, rgba(220,20,60,0.05), rgba(30,60,114,0.05)); }
    .preview { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:10px; }
    .preview-item { position:relative; border-radius:8px; overflow:hidden; aspect-ratio:1; background:#eee; }
    .preview-item img { width:100%; height:100%; object-fit:cover; }
    .rm { position:absolute; right:6px; top:6px; width:22px; height:22px; border:none; border-radius:50%; background:#dc3545; color:#fff; cursor:pointer; }
  </style>
  </style>
</head>
<body>
  <header>
    <div class="header-row">
      <span class="logo-text">VietLinker ‚Ä¢ Rao V·∫∑t</span>
      <div class="user-actions">
        <a href="#" class="btn-post" id="postNow">‚úçÔ∏è ƒêƒÉng tin</a>
        <div class="user-info" id="userInfo">
          <div class="user-avatar" id="userAvatar">U</div>
          <span class="user-name" id="userName">User</span>
        </div>
        <div class="auth-buttons" id="authButtons">
          <a href="login.html">ƒêƒÉng nh·∫≠p</a>
          <a href="register.html">ƒêƒÉng k√Ω</a>
        </div>
      </div>
    </div>
  </header>

  <nav>
    <div class="container">
      <div class="nav-links">
        <a href="index.html">Trang ch·ªß</a>
        <a href="marketplace.html">Mua B√°n</a>
        <a href="jobs.html">Vi·ªác L√†m</a>
        <a href="services.html">D·ªãch V·ª•</a>
        <a href="food.html">ƒÇn U·ªëng</a>
        <a href="realestate.html">BƒêS & Ti·ªám</a>
        <a href="classifieds.html" class="active">Rao V·∫∑t</a>
        <a href="promotions.html">Khuy·∫øn M√£i</a>
      </div>
    </div>
  </nav>

  <section class="hero">
    <div class="container">
      <h1>üì¢ Rao V·∫∑t C·ªông ƒê·ªìng</h1>
      <p>T√¨m ki·∫øm ‚Ä¢ ƒêƒÉng tin ‚Ä¢ K·∫øt n·ªëi trong c·ªông ƒë·ªìng ng∆∞·ªùi Vi·ªát</p>
    </div>
  </section>

  <!-- Quick Stats -->
  <div class="container" id="quickStats" style="margin-top:12px;">
    <div class="stats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
      <div class="stat" style="border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:14px;text-align:center;">
        <div style="font-size:24px;font-weight:800;color:#b91c3c" id="totalCount">0</div>
        <div style="color:#6b7280;font-size:13px">T·ªïng tin rao v·∫∑t</div>
      </div>
      <div class="stat" style="border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:14px;text-align:center;">
        <div style="font-size:24px;font-weight:800;color:#b91c3c" id="todayCount">0</div>
        <div style="color:#6b7280;font-size:13px">Tin m·ªõi h√¥m nay</div>
      </div>
      <div class="stat" style="border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:14px;text-align:center;">
        <div style="font-size:24px;font-weight:800;color:#b91c3c" id="activeCount">0</div>
        <div style="color:#6b7280;font-size:13px">ƒêang ho·∫°t ƒë·ªông</div>
      </div>
    </div>
  </div>

  <main class="container">
    <div class="search-row">
      <div class="search-input"><span class="icon">üîç</span><input id="searchInput" type="text" placeholder="T·ª´ kh√≥a" /></div>
      <div class="search-input"><span class="icon">üìç</span><input id="locationInput" type="text" placeholder="Zipcode ho·∫∑c Th√†nh ph·ªë" /></div>
      <div class="search-input">
        <span class="icon">üìÇ</span>
        <select id="categoryFilter">
          <option value="">T·∫•t c·∫£ danh m·ª•c</option>
          <option value="vehicle">Xe c·ªô</option>
          <option value="electronics">ƒêi·ªán t·ª≠</option>
          <option value="furniture">N·ªôi th·∫•t</option>
          <option value="clothes">Qu·∫ßn √°o</option>
          <option value="baby">M·∫π & B√©</option>
          <option value="pet">Th√∫ c∆∞ng</option>
          <option value="books">S√°ch b√°o</option>
          <option value="sports">Th·ªÉ thao</option>
          <option value="tools">D·ª•ng c·ª•</option>
          <option value="other">Kh√°c</option>
        </select>
      </div>
      <div><button class="btn-primary" id="searchBtn">T√åM KI·∫æM</button></div>
    </div>

    <div class="filters" id="typeFilters">
      <button class="pill active" data-type="all">T·∫•t c·∫£</button>
      <button class="pill" data-type="sell">C·∫ßn b√°n</button>
      <button class="pill" data-type="buy">C·∫ßn mua</button>
      <button class="pill" data-type="trade">Trao ƒë·ªïi</button>
      <button class="pill" data-type="free">Cho t·∫∑ng</button>
      <button class="pill" data-type="lost">Th·∫•t l·∫°c</button>
      <button class="pill" data-type="found">Nh·∫∑t ƒë∆∞·ª£c</button>
    </div>

    <div id="classifiedsContainer" class="grid"></div>
  </main>

  <button class="fab" id="postBtn" title="ƒêƒÉng tin">Ôºã</button>

  <!-- Post Modal -->
  <div class="modal" id="postModal">
    <div class="content">
      <div class="head"><h3>üìù ƒêƒÉng Tin Rao V·∫∑t</h3><button class="close" data-close="postModal">√ó</button></div>
      <div class="body">
        <form id="classifiedForm">
          <div class="form-group"><label for="title">Ti√™u ƒë·ªÅ *</label><input id="title" required /></div>
          <div class="row">
            <div class="form-group"><label for="type">Lo·∫°i tin *</label>
              <select id="type" required>
                <option value="">Ch·ªçn</option>
                <option value="sell">C·∫ßn b√°n</option>
                <option value="buy">C·∫ßn mua</option>
                <option value="trade">Trao ƒë·ªïi</option>
                <option value="free">Cho t·∫∑ng</option>
                <option value="lost">Th·∫•t l·∫°c</option>
                <option value="found">Nh·∫∑t ƒë∆∞·ª£c</option>
              </select>
            </div>
            <div class="form-group"><label for="category">Danh m·ª•c *</label>
              <select id="category" required>
                <option value="">Ch·ªçn</option>
                <option value="vehicle">Xe c·ªô</option>
                <option value="electronics">ƒêi·ªán t·ª≠</option>
                <option value="furniture">N·ªôi th·∫•t</option>
                <option value="clothes">Qu·∫ßn √°o</option>
                <option value="baby">M·∫π & B√©</option>
                <option value="pet">Th√∫ c∆∞ng</option>
                <option value="books">S√°ch b√°o</option>
                <option value="sports">Th·ªÉ thao</option>
                <option value="tools">D·ª•ng c·ª•</option>
                <option value="other">Kh√°c</option>
              </select>
            </div>
          </div>
          <div class="form-group"><label for="price">Gi√°</label><input id="price" placeholder="VD: $500 ho·∫∑c Mi·ªÖn ph√≠" /></div>
          <div class="form-group"><label for="description">M√¥ t·∫£ *</label><textarea id="description" required></textarea></div>
          <div class="row">
            <div class="form-group"><label for="city">Th√†nh ph·ªë *</label><input id="city" required /></div>
            <div class="form-group"><label for="zipcode">Zipcode *</label><input id="zipcode" required maxlength="5" pattern="[0-9]{5}" /></div>
          </div>
          <div class="form-group"><label for="location">ƒê·ªãa ch·ªâ</label><input id="location" /></div>
          <div class="form-group"><label for="contact">S·ªë ƒëi·ªán tho·∫°i *</label><input id="contact" required /></div>
          <div class="form-group">
            <div class="upload" id="uploadArea">üì∑ K√©o th·∫£ ho·∫∑c b·∫•m ƒë·ªÉ ch·ªçn ·∫£nh</div>
            <input type="file" id="imageInput" accept="image/*" multiple style="display:none" />
            <div class="preview" id="uploadPreview"></div>
          </div>
          <button class="submit" type="submit">ƒêƒÉng Tin Ngay</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal" id="detailModal">
    <div class="content">
      <div class="head"><h3>Chi Ti·∫øt Rao V·∫∑t</h3><button class="close" data-close="detailModal">√ó</button></div>
      <div class="body">
        <div class="thumb" id="detailImage" style="height:260px;">üì¢</div>
        <div class="share-row" style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn-primary" id="shareFb">üìò Facebook</button>
          <button class="btn-primary" id="shareZalo">üí¨ Zalo</button>
          <button class="btn-primary" id="shareCopy">üîó Copy link</button>
        </div>
        <h2 class="title" id="detailTitle" style="margin-top:12px;"></h2>
        <div id="detailPrice" style="font-weight:800;color:#b91c3c;margin:6px 0 10px;"></div>
        <div id="detailBadges" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
        <div id="detailDescription" class="desc" style="white-space:pre-wrap;margin-top:12px;"></div>
        <div class="meta" style="margin-top:12px;">
          <span id="detailLocation"></span>
          <span id="detailDate"></span>
          <span id="detailViews"></span>
        </div>
        <div style="display:flex; gap:10px; margin-top:16px;">
          <button class="btn-primary" id="callBtn">üìû G·ªçi</button>
          <button class="btn-primary" id="smsBtn">üí¨ SMS</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <script>
    // Core globals
    window.supabaseClient = null;
    window.currentUser = null;
    window.allClassifieds = [];
    window.selectedFiles = [];

    const SUPABASE_URL = 'https://wwlmvcsozavqfvwlxkrt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3bG12Y3NvemF2cWZ2d2x4a3J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzUyMTMsImV4cCI6MjA2OTk1MTIxM30.HdxvLlqJgdntVUQDVtVlkjJJa7bn9CoIVUG8yn3WkLQ';

    // FIX: helper to always return a ready supabase client
    function getSupabase() {
      if (window.supabaseClient) return window.supabaseClient;
      const supabaseLib = window.supabase || window.Supabase;
      if (supabaseLib && typeof supabaseLib.createClient === 'function') {
        try {
          window.supabaseClient = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          return window.supabaseClient;
        } catch (e) {
          console.error('Error creating Supabase client:', e);
          return null;
        }
      }
      return null;
    }

    // Optional: guard to avoid multiple inits
    let appInitialized = false;
    function initializeApp() {
      if (appInitialized) return; appInitialized = true;
      const sb = getSupabase();
      if (!sb) {
        document.getElementById('classifiedsContainer').innerHTML = '<div class="empty">Kh√¥ng th·ªÉ t·∫£i Supabase. Vui l√≤ng refresh.</div>';
        return;
      }
      setupEvents();
      checkAuth();
      loadClassifieds();
      loadStats();
    }

    async function checkAuth() {
      const sb = getSupabase();
      if (!sb) return;
      try {
        const { data: { session } } = await sb.auth.getSession();
        window.currentUser = session?.user || null;
        sb.auth.onAuthStateChange((_e, sess) => { window.currentUser = sess?.user || null; });
      } catch {}
    }

    async function loadClassifieds() {
      const container = document.getElementById('classifiedsContainer');
      container.innerHTML = '<div class="loading">ƒêang t·∫£i tin rao v·∫∑t...</div>';
      const sb = getSupabase();
      if (!sb) { container.innerHTML = '<div class="empty">Kh√¥ng th·ªÉ k·∫øt n·ªëi database</div>'; return; }
      try {
        const { data, error } = await sb
          .from('classifieds')
          .select('*')
          .eq('status', 'active')
          .order('created_at', { ascending: false });
        if (error) throw error;
        window.allClassifieds = data || [];
        renderClassifieds(window.allClassifieds);
      } catch (err) {
        console.error(err);
        container.innerHTML = '<div class="empty">L·ªói khi t·∫£i d·ªØ li·ªáu</div>';
      }
    }

    function renderClassifieds(list) {
      const container = document.getElementById('classifiedsContainer');
      if (!list || list.length === 0) { container.innerHTML = '<div class="empty">Ch∆∞a c√≥ tin rao v·∫∑t n√†o</div>'; return; }
      const typeLabels = { sell:'üè∑Ô∏è C·∫ßn b√°n', buy:'üõí C·∫ßn mua', trade:'üîÑ Trao ƒë·ªïi', free:'üéÅ Cho t·∫∑ng', lost:'üò¢ Th·∫•t l·∫°c', found:'üòä Nh·∫∑t ƒë∆∞·ª£c' };
      container.innerHTML = list.map((x, i) => `
        <div class="card" data-index="${i}">
          <div class="thumb">
            ${x.image_url ? `<img src="${x.image_url}" alt="${x.title}">` : 'üì¢'}
            <span class="badge">${typeLabels[x.type] || x.type || ''}</span>
            ${x.price ? `<span class="price">${x.price}</span>` : ''}
          </div>
          <div class="body">
            <div class="title">${x.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ'}</div>
            <div class="desc">${x.description || ''}</div>
            <div class="meta">
              <span>üìç ${x.city || ''}</span>
              <span>üëÅÔ∏è ${x.views || 0}</span>
              <span>üìÖ ${formatDate(x.created_at)}</span>
            </div>
            <div class="qa">
              <button data-act="call" data-phone="${x.contact || ''}">üìû G·ªçi</button>
              <button data-act="sms" data-phone="${x.contact || ''}" data-title="${(x.title||'').replace(/"/g,'&quot;')}">üí¨ SMS</button>
              <button data-act="share" data-title="${(x.title||'').replace(/"/g,'&quot;')}">üîó Chia s·∫ª</button>
            </div>
          </div>
        </div>
      `).join('');
      // attach click
      container.querySelectorAll('.card').forEach(el => el.addEventListener('click', () => {
        const idx = Number(el.getAttribute('data-index'));
        viewDetail(idx);
      }));
      // quick actions
      container.querySelectorAll('.qa button').forEach(btn => btn.addEventListener('click', ev => {
        ev.stopPropagation();
        const act = btn.getAttribute('data-act');
        if (act === 'call') { const p = btn.getAttribute('data-phone'); if (p) window.location.href = `tel:${p}`; }
        if (act === 'sms') { const p = btn.getAttribute('data-phone'); const t = btn.getAttribute('data-title'); if (p) window.location.href = `sms:${p}?body=${encodeURIComponent('Quan t√¢m: ' + (t||''))}`; }
        if (act === 'share') { const t = btn.getAttribute('data-title'); if (navigator.share) navigator.share({ title: t, text: 'Xem tin rao v·∫∑t: ' + t, url: window.location.href }); else copyLink(); }
      }));
    }

    function setupEvents() {
      // search
      document.getElementById('searchBtn').addEventListener('click', applyFilters);
      document.getElementById('searchInput').addEventListener('keypress', e => { if (e.key === 'Enter') applyFilters(); });
      // pills
      document.querySelectorAll('#typeFilters .pill').forEach(p => p.addEventListener('click', e => {
        document.querySelectorAll('#typeFilters .pill').forEach(x => x.classList.remove('active'));
        e.currentTarget.classList.add('active');
        applyFilters();
      }));
      // modals
      document.querySelectorAll('.close').forEach(btn => btn.addEventListener('click', () => closeModal(btn.getAttribute('data-close'))));
      document.getElementById('postBtn').addEventListener('click', showPostModal);
      const postNow = document.getElementById('postNow'); if (postNow) postNow.addEventListener('click', (e) => { e.preventDefault(); showPostModal(); });
      // upload
      const uploadArea = document.getElementById('uploadArea');
      const imageInput = document.getElementById('imageInput');
      if (uploadArea) {
        uploadArea.addEventListener('click', () => imageInput.click());
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); });
        uploadArea.addEventListener('drop', e => { e.preventDefault(); handleFileSelect(e.dataTransfer.files); });
      }
      if (imageInput) imageInput.addEventListener('change', e => handleFileSelect(e.target.files));
      // form
      const form = document.getElementById('classifiedForm');
      if (form) form.addEventListener('submit', handleSubmit);
    }

    async function applyFilters() {
      const sb = getSupabase(); if (!sb) return;
      const searchTerm = document.getElementById('searchInput').value.trim();
      const location = document.getElementById('locationInput').value.trim();
      const category = document.getElementById('categoryFilter').value;
      const activeType = document.querySelector('#typeFilters .pill.active')?.dataset.type || 'all';
      const container = document.getElementById('classifiedsContainer');
      container.innerHTML = '<div class="loading">ƒêang t√¨m ki·∫øm...</div>';
      try {
        let q = sb.from('classifieds').select('*').eq('status','active').order('created_at',{ ascending:false });
        if (activeType && activeType !== 'all') q = q.eq('type', activeType);
        if (category) q = q.eq('category', category);
        if (searchTerm) q = q.or(`title.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%`);
        if (location) {
          if (/^\d{5}$/.test(location)) q = q.eq('zipcode', location); else q = q.ilike('city', `%${location}%`);
        }
        const { data, error } = await q;
        if (error) throw error;
        window.allClassifieds = data || [];
        renderClassifieds(window.allClassifieds);
      } catch (err) {
        console.error(err);
        container.innerHTML = '<div class="empty">L·ªói khi t√¨m ki·∫øm</div>';
      }
    }

    async function loadStats() {
      const sb = getSupabase(); if (!sb) return;
      try {
        const today = new Date().toISOString().split('T')[0];
        const { count: total } = await sb.from('classifieds').select('*', { count: 'exact', head: true });
        const { count: todayCount } = await sb.from('classifieds').select('*', { count: 'exact', head: true }).gte('created_at', today);
        const { count: active } = await sb.from('classifieds').select('*', { count: 'exact', head: true }).eq('status', 'active');
        document.getElementById('totalCount').textContent = total || 0;
        document.getElementById('todayCount').textContent = todayCount || 0;
        document.getElementById('activeCount').textContent = active || 0;
      } catch (err) { console.warn('stats error', err); }
    }

    function handleFileSelect(fileList) {
      const files = Array.from(fileList || []);
      if (files.length > 5) { alert('T·ªëi ƒëa 5 h√¨nh ·∫£nh'); return; }
      window.selectedFiles = [];
      for (const f of files) {
        if (!f.type.startsWith('image/')) { alert(`File ${f.name} kh√¥ng ph·∫£i h√¨nh ·∫£nh`); continue; }
        if (f.size > 5 * 1024 * 1024) { alert(`File ${f.name} qu√° l·ªõn (>5MB)`); continue; }
        window.selectedFiles.push(f);
      }
      updatePreview();
    }

    function updatePreview() {
      const preview = document.getElementById('uploadPreview');
      if (!preview) return;
      preview.innerHTML = window.selectedFiles.map((f, i) => {
        const url = URL.createObjectURL(f);
        return `<div class="preview-item"><img src="${url}" alt="preview"><button class="rm" data-i="${i}">√ó</button></div>`;
      }).join('');
      preview.querySelectorAll('.rm').forEach(btn => btn.addEventListener('click', () => { removeImage(Number(btn.getAttribute('data-i'))); }));
    }

    function removeImage(i) {
      window.selectedFiles.splice(i, 1);
      updatePreview();
    }

    async function handleSubmit(e) {
      e.preventDefault();
      if (!currentUser) { if (confirm('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng tin. Chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p?')) window.location.href = 'login.html'; return; }
      const sb = getSupabase(); if (!sb) { alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi database'); return; }
      const submit = e.target.querySelector('button[type="submit"]');
      submit.disabled = true; submit.textContent = 'ƒêang ƒëƒÉng...';
      try {
        let imageUrl = null;
        if (selectedFiles.length > 0) {
          const file = selectedFiles[0];
          const fileName = `classified_${Date.now()}_${Math.random().toString(36).slice(2)}.${file.name.split('.').pop()}`;
          const { error: upErr } = await sb.storage.from('marketplace').upload(`classifieds/${fileName}`, file);
          if (upErr) throw upErr;
          const { data: pub } = sb.storage.from('marketplace').getPublicUrl(`classifieds/${fileName}`);
          imageUrl = pub?.publicUrl || null;
        }
        const payload = {
          user_id: currentUser.id,
          title: document.getElementById('title').value,
          description: document.getElementById('description').value,
          type: document.getElementById('type').value,
          category: document.getElementById('category').value,
          price: document.getElementById('price').value,
          location: document.getElementById('location').value,
          city: document.getElementById('city').value,
          zipcode: document.getElementById('zipcode').value,
          contact: document.getElementById('contact').value,
          image_url: imageUrl,
          status: 'active',
          views: 0
        };
        const { error } = await sb.from('classifieds').insert([payload]);
        if (error) throw error;
        alert('ƒêƒÉng tin th√†nh c√¥ng');
        closeModal('postModal'); e.target.reset(); selectedFiles = []; updatePreview();
        loadClassifieds();
      } catch (err) {
        console.error(err); alert('L·ªói: ' + (err?.message || 'Kh√¥ng r√µ'));
      } finally {
        submit.disabled = false; submit.textContent = 'ƒêƒÉng Tin Ngay';
      }
    }

    async function viewDetail(index) {
      const item = allClassifieds[index]; if (!item) return;
      const sb = getSupabase(); if (sb) { try { await sb.from('classifieds').update({ views: (item.views||0)+1 }).eq('id', item.id); } catch {} }
      document.getElementById('detailImage').innerHTML = item.image_url ? `<img src="${item.image_url}" alt="${item.title}">` : 'üì¢';
      document.getElementById('detailTitle').textContent = item.title || '';
      document.getElementById('detailPrice').textContent = item.price || 'Li√™n h·ªá';
      document.getElementById('detailDescription').textContent = item.description || '';
      document.getElementById('detailLocation').textContent = `${item.city || ''}, ${item.zipcode || ''}`;
      document.getElementById('detailDate').textContent = formatDate(item.created_at);
      document.getElementById('detailViews').textContent = `${(item.views||0)+1} l∆∞·ª£t xem`;
      document.getElementById('detailBadges').innerHTML = `<span class="pill">${item.type || ''}</span><span class="pill">${item.category || ''}</span>`;
      document.getElementById('callBtn').onclick = () => window.location.href = `tel:${item.contact}`;
      document.getElementById('smsBtn').onclick = () => window.location.href = `sms:${item.contact}?body=Quan t√¢m: ${encodeURIComponent(item.title||'')}`;
      openModal('detailModal');
      // share handlers
      const t = item.title || 'Rao v·∫∑t VietLinker';
      document.getElementById('shareFb').onclick = () => shareToFacebook(t);
      document.getElementById('shareZalo').onclick = () => shareToZalo();
      document.getElementById('shareCopy').onclick = () => copyLink();
    }

    function shareToFacebook(title) {
      const url = encodeURIComponent(window.location.href);
      const quote = encodeURIComponent(title);
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${quote}`, '_blank');
    }
    function shareToZalo() {
      const url = encodeURIComponent(window.location.href);
      window.open(`https://zalo.me/share?url=${url}`, '_blank');
    }
    function copyLink() {
      navigator.clipboard?.writeText(window.location.href).then(() => alert('ƒê√£ copy link!'));
    }

    function openModal(id) { const m = document.getElementById(id); if (m) m.style.display = 'block'; }
    function closeModal(id) { const m = document.getElementById(id); if (m) m.style.display = 'none'; }
    function showPostModal() { if (!currentUser) { if (confirm('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng tin. Chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p?')) window.location.href='login.html'; return; } openModal('postModal'); }

    function formatDate(d) {
      const date = new Date(d); const now = new Date(); const diffM = Math.floor((now - date)/60000);
      if (diffM < 60) return `${diffM} ph√∫t tr∆∞·ªõc`;
      if (diffM < 1440) return `${Math.floor(diffM/60)} gi·ªù tr∆∞·ªõc`;
      if (diffM < 43200) return `${Math.floor(diffM/1440)} ng√†y tr∆∞·ªõc`;
      return date.toLocaleDateString('vi-VN');
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>

