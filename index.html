<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VietLinker - Kết nối Cộng Đồng Việt tại Hoa Kỳ</title>
  <meta name="description" content="VietLinker: Mua bán, việc làm, dịch vụ, ăn uống, bất động sản, rao vặt của cộng đồng người Việt tại Hoa Kỳ" />

  <!-- Styles (rút gọn, tập trung phần tìm kiếm + modal + tiện ích) -->
  <style>
    :root {
      --primary: #1e3c72;
      --accent: #dc143c;
      --gold: #FFD700;
      --text: #222;
      --muted: #666;
      --bg: #f6f7fb;
      --white: #fff;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--text); background: var(--bg); }

    header { background: var(--white); position: sticky; top: 0; z-index: 30; box-shadow: var(--shadow); }
    .header-content {
      max-width: 1280px; margin: 0 auto; padding: 14px 20px;
      display: flex; align-items: center; justify-content: space-between; gap: 16px;
    }
    .logo { display: inline-flex; align-items: center; gap: 10px; text-decoration: none; color: var(--primary); font-weight: 800; font-size: 20px; }
    .user-actions { display: flex; align-items: center; gap: 10px; }
    .btn-post {
      background: linear-gradient(135deg, var(--accent) 0%, #b91c3c 100%); color: #fff; border: 0;
      padding: 10px 16px; border-radius: 999px; text-decoration: none; font-weight: 700; box-shadow: 0 6px 20px rgba(220,20,60,0.25);
    }
    .auth-buttons { display: flex; gap: 10px; }
    .btn-auth { text-decoration: none; font-weight: 700; border-radius: 999px; padding: 8px 14px; border: 2px solid var(--primary); color: var(--primary); background: #fff; }
    .btn-register { background: var(--primary); color: #fff; border-color: var(--primary); }

    nav { background: #ffffff; border-top: 1px solid #eee; }
    .nav-container { max-width: 1280px; margin: 0 auto; padding: 10px 20px; }
    .nav-links { display: flex; gap: 12px; overflow-x: auto; }
    .nav-links a { text-decoration: none; color: var(--text); padding: 8px 12px; border-radius: 10px; white-space: nowrap; }
    .nav-links a.active { background: #eef2ff; color: var(--primary); font-weight: 700; }

    /* Search section */
    .search { background: #fff; border-bottom: 1px solid #eee; }
    .search-inner { max-width: 1280px; margin: 0 auto; padding: 16px 20px; }
    .mega-search-box {
      display: flex; gap: 12px; align-items: stretch; flex-wrap: wrap; background: #f9fafb; padding: 12px; border-radius: 14px; border: 1px solid #eee;
    }
    .search-input-group {
      background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px 12px; display: flex; align-items: center; gap: 8px; min-height: 44px;
    }
    .search-input-group input, .search-input-group select {
      border: 0; outline: 0; font-size: 14px; min-width: 220px; background: transparent;
    }
    .search-btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, #2a5298 100%); color: white; border: 0; font-weight: 800;
      padding: 10px 20px; border-radius: 12px; display: inline-flex; align-items: center; gap: 8px; cursor: pointer;
    }
    .quick-searches { margin-top: 10px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .quick-search-tag { text-decoration: none; font-size: 13px; background: #fff; border: 1px solid #eee; padding: 6px 10px; border-radius: 999px; color: var(--text); }

    /* Modal */
    .search-results-modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; z-index: 50; padding: 20px;
    }
    .search-results-content {
      background: #fff; max-width: 900px; margin: 0 auto; border-radius: 16px; overflow: hidden; box-shadow: var(--shadow);
      display: grid; grid-template-rows: auto 1fr; height: calc(100vh - 40px);
    }
    .search-results-header {
      display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid #eee;
      position: sticky; top: 0; background: #fff; z-index: 1;
    }
    .close-search-modal { background: transparent; border: 0; font-size: 28px; line-height: 1; cursor: pointer; color: var(--muted); }
    .search-results-body { overflow: auto; padding: 16px; }

    /* Helpers */
    .hidden { display: none !important; }
    .user-info { display: none; align-items: center; gap: 8px; position: relative; }
    .user-info.active { display: inline-flex; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: #eef2ff; color: var(--primary); display: grid; place-items: center; font-weight: 800; }
    .user-menu { display: none; }
    .user-menu.active { display: inline-flex; gap: 10px; }
    .nav-divider { width: 1px; height: 20px; background: #eee; }

    /* Simple sections to keep page complete */
    .section { padding: 40px 20px; max-width: 1280px; margin: 0 auto; }
    .hero { background: linear-gradient(135deg, #f8fafc 0%, #fff 100%); }
    .section h2 { margin: 0 0 6px; color: var(--primary); }
    .muted { color: var(--muted); }
    footer { margin-top: 40px; background: var(--primary); color: #fff; }
    .footer-inner { max-width: 1280px; margin: 0 auto; padding: 24px 20px; display: grid; gap: 8px; }
    .floating-post-btn {
      position: fixed; right: 20px; bottom: 20px; width: 58px; height: 58px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent) 0%, #b91c3c 100%); color: #fff; display: grid; place-items: center; text-decoration: none;
      font-size: 22px; box-shadow: 0 10px 30px rgba(220,20,60,0.35); z-index: 40;
    }
    @media (max-width: 768px) {
      .search-input-group input, .search-input-group select { min-width: 0; width: 100%; }
      .search-btn-primary { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-content">
      <a class="logo" href="index.html" aria-label="VietLinker">
        <svg width="26" height="26" viewBox="0 0 100 100" aria-hidden="true">
          <circle cx="50" cy="50" r="45" fill="#1e3c72" opacity="0.1"/>
          <circle cx="50" cy="25" r="8" fill="#dc143c"/>
          <circle cx="25" cy="50" r="8" fill="#FFD700"/>
        </svg>
        <span>VietLinker</span>
      </a>

      <div class="user-actions">
        <a href="post-form.html" class="btn-post">✍️ Đăng tin</a>

        <div class="user-info" id="userInfo">
          <div class="user-avatar" id="userAvatar">U</div>
          <span class="user-name" id="userName">User</span>
        </div>

        <div class="auth-buttons" id="authButtons">
          <a href="login.html" class="btn-auth btn-login">Đăng Nhập</a>
          <a href="register.html" class="btn-auth btn-register">Đăng Ký Ngay</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Nav -->
  <nav>
    <div class="nav-container">
      <div class="nav-links">
        <a href="index.html" class="active">🏠 Trang Chủ</a>

        <div class="user-menu" id="userMenu">
          <div class="nav-divider"></div>
          <a href="profile.html">👤 Hồ Sơ</a>
          <a href="my-posts.html">📝 Tin Đăng</a>
          <div class="nav-divider"></div>
        </div>

        <a href="marketplace.html">🛒 Mua Bán</a>
        <a href="jobs.html">💼 Việc Làm</a>
        <a href="services.html">🤝 Dịch Vụ</a>
        <a href="food.html">🍜 Ăn Uống</a>
        <a href="realestate.html">🏠 BĐS & Tiệm</a>
        <a href="classifieds.html">📋 Rao Vặt</a>
        <a href="promotions.html">🎁 Khuyến Mãi</a>
      </div>
    </div>
  </nav>

  <!-- Search -->
  <section class="search" aria-label="Tìm kiếm">
    <div class="search-inner">
      <div class="mega-search-box">
        <div class="search-input-group">
          <span class="input-icon" aria-hidden="true">🔎</span>
          <input type="text" id="searchKeyword" placeholder="Từ khóa (ví dụ: nail, phở, Honda)" aria-label="Từ khóa">
        </div>

        <div class="search-input-group location-group">
          <span class="input-icon" aria-hidden="true">📍</span>
          <input type="text" id="searchLocation" placeholder="Zipcode hoặc Thành phố" aria-label="Khu vực">
        </div>

        <div class="search-input-group">
          <span class="input-icon" aria-hidden="true">📂</span>
          <select id="searchCategory" aria-label="Danh mục">
            <option value="">Tất cả danh mục</option>
            <option value="jobs">💼 Việc làm</option>
            <option value="marketplace">🛒 Mua bán</option>
            <option value="services">🤝 Dịch vụ</option>
            <option value="food_dining">🍜 Ăn uống</option>
            <option value="real_estate">🏠 Bất động sản</option>
            <option value="classifieds">📋 Rao vặt</option>
            <option value="promotions">🎁 Khuyến mãi</option>
          </select>
        </div>

        <button class="search-btn-primary" id="searchButton" type="button">
          <span>🔍</span><span>TÌM KIẾM</span>
        </button>
      </div>

      <div class="quick-searches">
        <span>Tìm nhanh:</span>
        <a href="#" class="quick-search-tag" data-search="Thợ Nail">Thợ Nail</a>
        <a href="#" class="quick-search-tag" data-search="Phòng cho thuê">Phòng cho thuê</a>
        <a href="#" class="quick-search-tag" data-search="Honda Civic">Honda Civic</a>
        <a href="#" class="quick-search-tag" data-search="Phở">Phở</a>
        <a href="#" class="quick-search-tag" data-search="Tiệm nail">Tiệm nail</a>
      </div>
    </div>
  </section>

  <!-- Search Results Modal -->
  <div id="searchResultsModal" class="search-results-modal" role="dialog" aria-modal="true" aria-labelledby="searchResultsTitle">
    <div class="search-results-content">
      <div class="search-results-header">
        <h3 id="searchResultsTitle" style="margin:0;color:var(--primary);">Kết quả tìm kiếm</h3>
        <button class="close-search-modal" id="closeModalBtn" aria-label="Đóng">&times;</button>
      </div>
      <div class="search-results-body" id="searchResultsBody"></div>
    </div>
  </div>

  <!-- Simple sections to keep page complete -->
  <section class="section hero">
    <h2>Kết Nối Cộng Đồng Việt tại Hoa Kỳ</h2>
    <p class="muted">Từ mua bán, việc làm, dịch vụ, ẩm thực đến bất động sản - Tất cả trong một!</p>
  </section>

  <section class="section">
    <h2>Danh mục nổi bật</h2>
    <p class="muted">Việc Làm, Dịch Vụ, Ăn Uống, BĐS & Tiệm, Rao Vặt, Khuyến Mãi</p>
  </section>

  <section class="section">
    <h2>Tại sao chọn VietLinker?</h2>
    <p class="muted">An toàn, miễn phí, dễ dùng, cập nhật liên tục, cộng đồng lớn mạnh.</p>
  </section>

  <section class="section" style="text-align:center;">
    <h2>Sẵn sàng kết nối?</h2>
    <p class="muted">Tham gia cộng đồng VietLinker ngay hôm nay và khám phá cơ hội</p>
    <div style="display:inline-flex; gap:10px; flex-wrap:wrap; justify-content:center;">
      <a href="register.html" class="btn-post" style="box-shadow:none;">✨ Đăng Ký Miễn Phí</a>
      <a href="marketplace.html" class="btn-auth btn-login" style="border-color:var(--primary);">🔍 Xem Tin Đăng</a>
    </div>
  </section>

  <footer>
    <div class="footer-inner">
      <div>&copy; 2024 VietLinker. Tất cả quyền được bảo lưu. Made with ❤️ for Vietnamese Community</div>
    </div>
  </footer>

  <!-- Floating Post Button -->
  <a href="post-form.html" class="floating-post-btn" title="Đăng tin">✍️</a>

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <script>
    // Cấu hình Supabase (THAY bằng thông tin của bạn)
    const SUPABASE_URL = 'https://YOUR_PROJECT_ID.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

    const supabase = (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    // Helpers
    function getEl(id) { return document.getElementById(id); }
    function openModal() { const m = getEl('searchResultsModal'); if (m) m.style.display = 'block'; }
    function closeModal() { const m = getEl('searchResultsModal'); if (m) m.style.display = 'none'; }
    getEl('closeModalBtn')?.addEventListener('click', closeModal);
    window.addEventListener('click', (e) => { const m = getEl('searchResultsModal'); if (e.target === m) closeModal(); });

    // Safe element factory
    function el(tag, props = {}, ...children) {
      const node = document.createElement(tag);
      Object.entries(props).forEach(([k, v]) => {
        if (k === 'class') node.className = v;
        else if (k === 'text') node.textContent = v ?? '';
        else if (k.startsWith('aria-')) node.setAttribute(k, v);
        else if (v !== undefined && v !== null) node.setAttribute(k, v);
      });
      children.forEach(child => {
        if (child == null) return;
        if (child instanceof Node) node.appendChild(child);
        else node.appendChild(document.createTextNode(String(child)));
      });
      return node;
    }

    // Render results safely
    function renderResults(groups) {
      const body = getEl('searchResultsBody');
      if (!body) return;
      body.innerHTML = '';

      if (!groups || groups.length === 0) {
        body.appendChild(el('div', { style: 'text-align:center;padding:40px;' }, '😔 Không tìm thấy kết quả nào.'));
        return;
      }

      const nameMap = {
        jobs: '💼 Việc Làm',
        marketplace: '🛒 Mua Bán',
        services: '🤝 Dịch Vụ',
        food_dining: '🍜 Ăn Uống',
        real_estate: '🏠 Bất Động Sản',
        classifieds: '📋 Rao Vặt',
        promotions: '🎁 Khuyến Mãi'
      };

      const wrap = el('div');
      groups.forEach(group => {
        const title = el('h4', { style: 'margin:10px 0;color:var(--primary);' }, `${nameMap[group.table] || group.table} (${group.data.length})`);
        wrap.appendChild(title);

        group.data.forEach(item => {
          const card = el('div', { style: 'background:#f8f9fa;padding:12px;border-radius:12px;margin:8px 0;border:1px solid #eee;' });
          const h = el('div', { style: 'font-weight:700;color:#1e3c72;' }, item.title || item.name || '(Không tiêu đề)');
          const meta = el('div', { style: 'display:flex;gap:12px;color:#888;font-size:13px;margin:4px 0;' });
          if (item.city) meta.appendChild(el('span', { text: `📍 ${item.city}` }));
          if (item.zipcode) meta.appendChild(el('span', { text: `🏷️ ${item.zipcode}` }));
          if (item.price || item.price_range) meta.appendChild(el('span', { text: `💰 ${item.price || item.price_range}` }));
          const descText = (item.description || '').toString();
          const desc = el('div', { style: 'color:#444;font-size:14px;' }, descText.length > 160 ? descText.slice(0, 160) + '…' : descText);

          card.append(h, meta, desc);
          wrap.appendChild(card);
        });
      });

      body.appendChild(wrap);
    }

    async function performGlobalSearch() {
      const kwEl = getEl('searchKeyword');
      const lcEl = getEl('searchLocation');
      const catEl = getEl('searchCategory');

      const keyword = kwEl?.value?.trim() || '';
      const location = lcEl?.value?.trim() || '';
      const category = catEl?.value || '';

      if (!keyword && !location && !category) {
        alert('Vui lòng nhập thông tin tìm kiếm!');
        return;
      }

      openModal();
      const body = getEl('searchResultsBody');
      if (body) body.innerHTML = '<div style="text-align:center;padding:40px;">🔍 Đang tìm kiếm...</div>';
      if (!supabase) {
        // No Supabase: mock result
        const mock = [{ table: category || 'marketplace', data: [{ title: 'Kết quả mẫu', city: 'San Jose, CA', price: '$100', description: 'Ví dụ minh hoạ khi chưa cấu hình Supabase.' }] }];
        renderResults(mock);
        return;
      }

      const allTables = ['jobs', 'marketplace', 'services', 'food_dining', 'real_estate', 'classifieds', 'promotions'];
      const tables = category ? [category] : allTables;

      const groups = [];
      await Promise.all(tables.map(async (table) => {
        let q = supabase.from(table).select('title,name,description,city,zipcode,price,price_range').limit(10);

        if (keyword) {
          // Tìm trong title + description
          q = q.or(`title.ilike.%${keyword}%,description.ilike.%${keyword}%`);
        }
        if (location) {
          if (/^\d{5}$/.test(location)) {
            q = q.eq('zipcode', location);
          } else {
            q = q.ilike('city', `%${location}%`);
          }
        }

        const { data, error } = await q;
        if (!error && data && data.length) groups.push({ table, data });
      }));

      if (groups.length === 0) {
        renderResults([]);
      } else {
        renderResults(groups);
      }
    }

    async function checkAuth() {
      if (!supabase) return;
      const { data } = await supabase.auth.getUser();
      const user = data?.user;
      const userInfo = getEl('userInfo');
      const authButtons = getEl('authButtons');
      const userMenu = getEl('userMenu');

      if (user) {
        userInfo?.classList.add('active');
        authButtons?.classList.add('hidden');
        userMenu?.classList.add('active');

        // Ví dụ lấy tên hiển thị
        let displayName = user.email;
        // Nếu có bảng users, có thể load thêm tên
        try {
          const { data: u } = await supabase.from('users').select('full_name,name').eq('email', user.email).single();
          if (u) displayName = u.full_name || u.name || displayName;
        } catch {}
        const nameEl = getEl('userName'); if (nameEl) nameEl.textContent = displayName;
        const avaEl = getEl('userAvatar'); if (avaEl) avaEl.textContent = (displayName || 'U').charAt(0).toUpperCase();
      } else {
        userInfo?.classList.remove('active');
        authButtons?.classList.remove('hidden');
        userMenu?.classList.remove('active');
      }
    }

    async function signOut() {
      if (!supabase) return;
      if (!confirm('Bạn có chắc muốn đăng xuất?')) return;
      await supabase.auth.signOut();
      location.reload();
    }

    function getUserLocation() {
      if (!('geolocation' in navigator)) return;
      // Geolocation yêu cầu HTTPS (trừ localhost)
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          console.log('Location:', pos.coords.latitude, pos.coords.longitude);
        },
        (err) => {
          console.log('Geolocation error:', err?.message);
        },
        { enableHighAccuracy: false, timeout: 5000 }
      );
    }

    // Wire up events
    window.addEventListener('load', () => {
      console.log('✅ VietLinker Ready');
      getEl('searchButton')?.addEventListener('click', performGlobalSearch);
      getEl('searchKeyword')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') performGlobalSearch(); });
      getEl('searchLocation')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') performGlobalSearch(); });
      document.querySelectorAll('.quick-search-tag').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const kw = a.getAttribute('data-search') || '';
          const elKw = getEl('searchKeyword'); if (elKw) elKw.value = kw;
          performGlobalSearch();
        });
      });

      // init auth & location
      checkAuth();
      getUserLocation();
    });

    // Expose signOut (nếu được dùng bởi menu)
    window.signOut = signOut;
  </script>
</body>
</html>
