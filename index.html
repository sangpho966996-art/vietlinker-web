<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VietLinker Search</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    #searchBox { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    input, select, button { padding: 10px; font-size: 16px; }
    button { cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; }
    button:hover { background: #0056b3; }
    #results { background: white; padding: 15px; border-radius: 5px; }
    .item { border-bottom: 1px solid #eee; padding: 10px 0; }
    .item h4 { margin: 0; color: #007bff; }
    .item p { margin: 5px 0 0; color: #555; }
    /* Spinner */
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="searchBox">
    <input type="text" id="searchKeyword" placeholder="Nh·∫≠p t·ª´ kh√≥a...">
    <input type="text" id="searchLocation" placeholder="Nh·∫≠p ƒë·ªãa ƒëi·ªÉm...">
    <select id="searchCategory">
        <option value="">T·∫•t c·∫£ danh m·ª•c</option>
        <option value="jobs">Vi·ªác l√†m</option>
        <option value="marketplace">Mua b√°n</option>
        <option value="services">D·ªãch v·ª•</option>
        <option value="food_dining">ƒÇn u·ªëng</option>
        <option value="real_estate">B·∫•t ƒë·ªông s·∫£n</option>
        <option value="classifieds">Rao v·∫∑t</option>
        <option value="promotions">Khuy·∫øn m√£i</option>
    </select>
    <button id="searchBtn">üîç T√¨m ki·∫øm</button>
</div>

<div id="results"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
    const SUPABASE_URL = "https://wwlmvcsozavqfvwlxkrt.supabase.co";
    const SUPABASE_KEY = "YOUR_SUPABASE_ANON_KEY";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const searchBtn = document.getElementById("searchBtn");
    let searchTimeout;

    searchBtn.addEventListener("click", () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300); // debounce 300ms
    });

    async function performSearch() {
        const keyword = document.getElementById("searchKeyword").value.trim();
        const location = document.getElementById("searchLocation").value.trim();
        const category = document.getElementById("searchCategory").value;

        const tables = category ? [category] : 
            ["jobs", "marketplace", "services", "food_dining", "real_estate", "classifieds", "promotions"];

        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = `<div class="spinner"></div>`;

        const allResults = [];

        for (const table of tables) {
            let query = supabaseClient.from(table).select("*").eq("status", "active").limit(10);

            if (keyword) {
                const orFilters = table === "food_dining" ?
                    [`title.ilike.%${keyword}%`, `description.ilike.%${keyword}%`, `business_name.ilike.%${keyword}%`] :
                    [`title.ilike.%${keyword}%`, `description.ilike.%${keyword}%`];
                query = query.or(orFilters.join(","));
            }

            if (location) {
                if (/^\d{5}$/.test(location)) {
                    query = query.eq("zipcode", location);
                } else {
                    query = query.ilike("city", `%${location}%`);
                }
            }

            const { data, error } = await query;
            if (!error && data.length) {
                allResults.push({ table, data });
            }
        }

        displayResults(allResults);
    }

    function displayResults(allResults) {
        const resultsDiv = document.getElementById("results");
        if (!allResults.length) {
            resultsDiv.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</p>";
            return;
        }

        const tableNames = {
            jobs: "üíº Vi·ªác L√†m",
            marketplace: "üõí Mua B√°n",
            services: "ü§ù D·ªãch V·ª•",
            food_dining: "üçú ƒÇn U·ªëng",
            real_estate: "üè† B·∫•t ƒê·ªông S·∫£n",
            classifieds: "üìã Rao V·∫∑t",
            promotions: "üéÅ Khuy·∫øn M√£i"
        };

        let html = "";
        allResults.forEach(({ table, data }) => {
            html += `<h3>${tableNames[table] || table}</h3>`;
            data.forEach(item => {
                html += `<div class="item">
                            <h4>${escapeHtml(item.title || item.business_name || "Kh√¥ng ti√™u ƒë·ªÅ")}</h4>
                            <p>${escapeHtml(item.description || "").slice(0, 100)}...</p>
                         </div>`;
            });
        });
        resultsDiv.innerHTML = html;
    }

    function escapeHtml(text) {
        return text.replace(/[&<>"']/g, (m) => ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;"
        })[m]);
    }
</script>

</body>
</html>
