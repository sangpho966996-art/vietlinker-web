<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mua BÃ¡n - VietLinker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin="anonymous">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
      min-height:100vh
    }
    .container{background:#fff;min-height:100vh}
    header{
      background:linear-gradient(135deg,#1e3c72 0%,#dc143c 100%);color:#fff;padding:20px;text-align:center;position:relative;overflow:hidden
    }
    header::before{content:'';position:absolute;top:-50%;right:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 70%);animation:shimmer 3s infinite}
    @keyframes shimmer{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    header h1{font-size:1.8em;margin-bottom:5px;position:relative;z-index:1}
    header p{font-size:.95em;opacity:.95;position:relative;z-index:1}
    nav{background:#1e3c72;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);position:sticky;top:0;z-index:100}
    .nav-wrapper{display:flex;justify-content:space-between;align-items:center}
    .nav-toggle{display:block;background:none;border:none;color:#fff;font-size:24px;cursor:pointer;padding:5px}
    .nav-links{display:none;position:absolute;top:100%;left:0;right:0;background:#1e3c72;flex-direction:column;padding:10px;box-shadow:0 5px 15px rgba(0,0,0,.2)}
    .nav-links.active{display:flex}
    .nav-links a{color:#fff;text-decoration:none;padding:12px;border-radius:5px;transition:all .3s}
    .nav-links a:hover,.nav-links a.active{background:rgba(220,20,60,.3)}
    .user-info{color:#fff;display:flex;align-items:center;gap:10px;font-size:.9em}
    .logout-btn{background:#dc143c;color:#fff;border:none;padding:6px 12px;border-radius:5px;cursor:pointer;font-size:.9em}
    .main-content{padding:15px;background:#f8f9fa;min-height:calc(100vh - 200px)}
    .actions-bar{background:#fff;padding:15px;border-radius:12px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .search-bar{display:flex;flex-direction:column;gap:10px;margin-bottom:12px}
    .location-input{display:flex;align-items:center;gap:5px;padding:10px;background:#fff;border:2px solid #e0e0e0;border-radius:8px}
    .location-input input{border:none;outline:none;flex:1;font-size:14px}
    .search-bar input,.search-bar select{padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;width:100%}
    .search-bar input:focus,.search-bar select:focus{outline:none;border-color:#1e3c72}
    .filters-advanced{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .filters-row{display:flex;gap:10px;flex-wrap:wrap}
    .check-group{display:flex;flex-wrap:wrap;gap:8px}
    .check-group label{display:flex;align-items:center;gap:6px;background:#fff;border:2px solid #e0e0e0;border-radius:20px;padding:6px 10px;font-size:.9em}
    .btn{background:linear-gradient(135deg,#dc143c 0%,#b91c3c 100%);color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all .3s;width:100%;text-align:center}
    .btn-secondary{background:#1e3c72}
    .items-grid{display:grid;grid-template-columns:1fr;gap:15px}
    .item-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 3px 10px rgba(0,0,0,.08);transition:all .3s;cursor:pointer;position:relative}
    .item-card:active{transform:scale(.98)}
    .item-badge{position:absolute;top:10px;left:10px;background:#dc143c;color:#fff;padding:4px 10px;border-radius:15px;font-size:.75em;font-weight:600;z-index:1}
    .item-heart{position:absolute;top:10px;right:10px;background:rgba(255,255,255,.9);backdrop-filter:blur(4px);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;z-index:1;font-size:18px;border:1px solid #eee}
    .item-image{width:100%;height:180px;background:linear-gradient(135deg,#f0f0f0 0%,#e0e0e0 100%);display:flex;align-items:center;justify-content:center;font-size:50px;overflow:hidden}
    .item-image img{width:100%;height:100%;object-fit:cover}
    .item-body{padding:15px}
    .item-category{display:inline-block;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);color:#fff;padding:3px 10px;border-radius:12px;font-size:.75em;margin-bottom:8px}
    .item-title{font-size:1.1em;font-weight:700;color:#1e3c72;margin-bottom:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .item-price{font-size:1.25em;color:#dc143c;font-weight:700;margin-bottom:10px}
    .item-details{display:flex;flex-direction:column;gap:6px;font-size:.85em;color:#666}
    .loading{text-align:center;padding:40px;color:#666}
    .empty-state{text-align:center;padding:40px 20px;color:#999;background:#fff;border-radius:12px}
    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;overflow-y:auto}
    .modal-content{background:#fff;margin:20px;border-radius:15px;animation:slideUp .3s;max-height:calc(100vh - 40px);overflow-y:auto}
    @keyframes slideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
    .modal-header{background:linear-gradient(135deg,#1e3c72 0%,#dc143c 100%);color:#fff;padding:16px 16px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10}
    .close-modal{font-size:26px;color:#fff;cursor:pointer;background:none;border:none;width:30px;height:30px;display:flex;align-items:center;justify-content:center}
    .modal-body{padding:16px}
    /* Detail */
    .detail-title{color:#1e3c72;font-size:1.4em;font-weight:800;margin:8px 0}
    .detail-price{font-size:1.6em;color:#dc143c;font-weight:800;margin:6px 0}
    .detail-row{display:grid;grid-template-columns:1fr;gap:12px}
    .detail-meta{background:#f8f9fa;padding:12px;border-radius:10px}
    .meta-item{display:flex;gap:8px;margin-bottom:8px}
    .meta-item .label{min-width:100px;color:#1e3c72;font-weight:700}
    .detail-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn-outline{background:#fff;color:#1e3c72;border:2px solid #1e3c72}
    /* Gallery */
    .gallery{position:relative}
    .gallery-main{width:100%;height:260px;background:#f0f0f0;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .gallery-main img{width:100%;height:100%;object-fit:cover;cursor:zoom-in}
    .gallery-thumbs{display:flex;gap:8px;margin-top:8px;overflow-x:auto}
    .thumb{width:60px;height:60px;border-radius:8px;overflow:hidden;border:2px solid transparent;flex:0 0 auto;cursor:pointer}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb.active{border-color:#dc143c}
    .gallery-nav{position:absolute;inset:0;display:flex;align-items:center;justify-content:space-between;pointer-events:none}
    .nav-btn{pointer-events:auto;background:rgba(0,0,0,.35);color:#fff;border:none;border-radius:50%;width:34px;height:34px;display:flex;align-items:center;justify-content:center}
    /* Zoom overlay */
    .zoom-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:2000;align-items:center;justify-content:center}
    .zoom-overlay img{max-width:90vw;max-height:90vh;border-radius:8px}
    /* Sections */
    .section-title{font-size:1.2em;color:#1e3c72;font-weight:800;margin:10px 0}
    .stars{display:flex;gap:4px;font-size:20px;cursor:pointer}
    .star.active{color:#dc143c}
    .review{border:1px solid #eee;border-radius:8px;padding:10px;margin-bottom:8px}
    .tag{display:inline-block;background:#f1f3f5;border:1px solid #e9ecef;border-radius:20px;padding:4px 10px;font-size:.85em;margin:4px}
    /* Map */
    #map{width:100%;height:260px;border-radius:10px;overflow:hidden}
    .map-wrap{background:#fff;border:1px solid #eee;border-radius:10px;padding:10px}
    /* Desktop */
    @media(min-width:768px){
      body{padding:20px}
      .container{max-width:1200px;margin:0 auto;border-radius:20px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3)}
      header{padding:30px}
      header h1{font-size:2.2em;margin-bottom:8px}
      header p{font-size:1.05em}
      nav{padding:15px 30px;position:static}
      .nav-wrapper{display:block}
      .nav-toggle{display:none}
      .nav-links{display:flex!important;position:static;flex-direction:row;padding:0;gap:20px;box-shadow:none}
      .nav-links a{padding:8px 16px}
      .main-content{padding:24px}
      .actions-bar{padding:20px;display:flex;justify-content:space-between;align-items:flex-start}
      .search-bar{flex-direction:row;flex:1;gap:10px;align-items:flex-start}
      .filters-advanced{grid-template-columns:repeat(4,1fr)}
      .btn{width:auto;padding:12px 24px}
      .items-grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px}
      .modal-content{margin:40px auto;width:92%;max-width:860px}
      .gallery-main{height:360px}
      #map{height:320px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ›’ Chá»£ Mua BÃ¡n</h1>
      <p>Mua bÃ¡n xe hÆ¡i, Ä‘á»“ Ä‘iá»‡n tá»­, ná»™i tháº¥t vÃ  nhiá»u máº·t hÃ ng khÃ¡c</p>
    </header>

    <nav>
      <div class="nav-wrapper">
        <button class="nav-toggle" onclick="toggleNav()">â˜°</button>
        <div class="nav-links" id="navLinks">
          <a href="index.html">ğŸ  Trang chá»§</a>
          <a href="jobs.html">ğŸ’¼ Viá»‡c lÃ m</a>
          <a href="marketplace.html" class="active">ğŸ›’ Mua bÃ¡n</a>
          <a href="services.html">ğŸ¤ Dá»‹ch vá»¥</a>
          <a href="food.html">ğŸœ Ä‚n uá»‘ng</a>
          <a href="realestate.html">ğŸ  BÄS</a>
          <a href="classifieds.html">ğŸ“‹ Rao váº·t</a>
          <a href="promotions.html">ğŸ Khuyáº¿n mÃ£i</a>
        </div>
        <div class="user-info">
          <span id="userEmail">ChÆ°a Ä‘Äƒng nháº­p</span>
          <button class="logout-btn" id="logoutBtn" style="display:none">ÄÄƒng xuáº¥t</button>
        </div>
      </div>
    </nav>

    <div class="main-content">
      <div class="actions-bar">
        <div class="search-bar" style="flex:1">
          <div class="location-input">
            <span>ğŸ“</span>
            <input type="text" id="locationInput" placeholder="Zipcode hoáº·c ThÃ nh phá»‘" />
          </div>

          <select id="categoryFilter">
            <option value="">Táº¥t cáº£ danh má»¥c</option>
            <option value="car">ğŸš— Xe hÆ¡i</option>
            <option value="motorcycle">ğŸï¸ Xe mÃ¡y</option>
            <option value="electronics">ğŸ“± Äiá»‡n tá»­</option>
            <option value="furniture">ğŸ›‹ï¸ Ná»™i tháº¥t</option>
            <option value="appliances">ğŸ  Äá»“ gia dá»¥ng</option>
            <option value="clothing">ğŸ‘• Quáº§n Ã¡o</option>
            <option value="jewelry">ğŸ’ Trang sá»©c</option>
            <option value="sports">âš½ Thá»ƒ thao</option>
            <option value="toys">ğŸ§¸ Äá»“ chÆ¡i</option>
            <option value="food">ğŸœ Thá»±c pháº©m</option>
            <option value="other">ğŸ“¦ KhÃ¡c</option>
          </select>

          <input type="text" id="searchInput" placeholder="TÃ¬m kiáº¿m sáº£n pháº©m...">

          <div class="filters-advanced">
            <input type="number" id="priceMin" placeholder="GiÃ¡ tá»« (USD)" min="0">
            <input type="number" id="priceMax" placeholder="GiÃ¡ Ä‘áº¿n (USD)" min="0">
            <select id="sortSelect">
              <option value="newest">Má»›i nháº¥t</option>
              <option value="price_asc">GiÃ¡ tÄƒng dáº§n</option>
              <option value="price_desc">GiÃ¡ giáº£m dáº§n</option>
            </select>
            <input type="text" id="tagsFilter" placeholder="Tags (vd: honda, civic)">
          </div>

          <div class="check-group" id="conditionChecks">
            <label><input type="checkbox" value="new"> Má»›i</label>
            <label><input type="checkbox" value="like-new"> NhÆ° má»›i</label>
            <label><input type="checkbox" value="good"> Tá»‘t</label>
            <label><input type="checkbox" value="fair"> KhÃ¡</label>
            <label><input type="checkbox" value="poor"> Cáº§n sá»­a</label>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:10px;min-width:180px">
          <button class="btn" id="postItemBtn">+ ÄÄƒng bÃ¡n</button>
          <button class="btn btn-secondary" id="toggleMapBtn">ğŸ—ºï¸ Xem báº£n Ä‘á»“</button>
        </div>
      </div>

      <div id="mapWrap" class="map-wrap" style="display:none">
        <div id="map"></div>
      </div>

      <div id="itemsContainer" class="items-grid">
        <div class="loading">Äang táº£i sáº£n pháº©m...</div>
      </div>
    </div>
  </div>

  <!-- Modal Ä‘Äƒng bÃ¡n -->
  <div id="itemModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ“ ÄÄƒng BÃ¡n Sáº£n Pháº©m</h2>
        <button class="close-modal" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="itemForm">
          <div class="form-group">
            <label for="title">TÃªn sáº£n pháº©m *</label>
            <input type="text" id="title" required placeholder="VD: Toyota Camry 2018, iPhone 14 Pro...">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="category">Danh má»¥c *</label>
              <select id="category" required>
                <option value="">Chá»n danh má»¥c</option>
                <option value="car">ğŸš— Xe hÆ¡i</option>
                <option value="motorcycle">ğŸï¸ Xe mÃ¡y</option>
                <option value="electronics">ğŸ“± Äiá»‡n tá»­</option>
                <option value="furniture">ğŸ›‹ï¸ Ná»™i tháº¥t</option>
                <option value="appliances">ğŸ  Äá»“ gia dá»¥ng</option>
                <option value="clothing">ğŸ‘• Quáº§n Ã¡o</option>
                <option value="jewelry">ğŸ’ Trang sá»©c</option>
                <option value="sports">âš½ Thá»ƒ thao</option>
                <option value="toys">ğŸ§¸ Äá»“ chÆ¡i</option>
                <option value="food">ğŸœ Thá»±c pháº©m</option>
                <option value="other">ğŸ“¦ KhÃ¡c</option>
              </select>
            </div>

            <div class="form-group">
              <label for="condition">TÃ¬nh tráº¡ng *</label>
              <select id="condition" required>
                <option value="">Chá»n tÃ¬nh tráº¡ng</option>
                <option value="new">Má»›i 100%</option>
                <option value="like-new">NhÆ° má»›i (99%)</option>
                <option value="good">Tá»‘t (90%)</option>
                <option value="fair">KhÃ¡ (80%)</option>
                <option value="poor">Cáº§n sá»­a chá»¯a</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="price">GiÃ¡ (USD) *</label>
            <input type="number" id="price" required placeholder="VD: 15000" min="0">
          </div>

          <div class="form-group">
            <label for="description">MÃ´ táº£ chi tiáº¿t</label>
            <textarea id="description" rows="4" placeholder="MÃ´ táº£ tÃ¬nh tráº¡ng, Ä‘áº·c Ä‘iá»ƒm, lÃ½ do bÃ¡n..."></textarea>
          </div>

          <div class="form-group">
            <label>HÃ¬nh áº£nh sáº£n pháº©m (tá»‘i Ä‘a 10)</label>
            <input type="file" id="imageFiles" accept="image/*" multiple style="display:none">
            <div id="imageUploadArea" style="border:2px dashed #dc143c;padding:16px;text-align:center;border-radius:8px;background:#fff5f5;cursor:pointer">
              <div id="uploadPlaceholder">
                <div style="font-size:42px;margin-bottom:8px">ğŸ“·</div>
                <p style="color:#dc143c;font-weight:700">Click Ä‘á»ƒ chá»n hÃ¬nh (nhiá»u táº¥m)</p>
                <p style="color:#666;font-size:.9em">Hoáº·c kÃ©o tháº£ hÃ¬nh vÃ o Ä‘Ã¢y</p>
                <small style="color:#999">JPG, PNG, GIF - Tá»‘i Ä‘a 5MB má»—i áº£nh</small>
              </div>
              <div id="imagePreviewList" style="display:none;display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div>
            </div>
            <div id="uploadStatus" style="display:none;color:#28a745;font-size:.9em;margin-top:8px">âœ… ÄÃ£ upload hÃ¬nh!</div>
          </div>

          <div class="form-group">
            <label for="tags">Tags (phÃ¢n tÃ¡ch bá»Ÿi dáº¥u pháº©y)</label>
            <input type="text" id="tags" placeholder="vd: honda, civic, 2018">
          </div>

          <div class="form-group">
            <label for="location">Äá»‹a chá»‰ giao dá»‹ch</label>
            <input type="text" id="location" placeholder="VD: 123 Main St, Houston, TX">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="city">ThÃ nh phá»‘ *</label>
              <input type="text" id="city" required placeholder="VD: Houston">
            </div>
            <div class="form-group">
              <label for="zipcode">Zipcode *</label>
              <input type="text" id="zipcode" required placeholder="VD: 77001" pattern="[0-9]{5}" maxlength="5">
            </div>
          </div>

          <div class="form-group">
            <label for="contact">Sá»‘ Ä‘iá»‡n thoáº¡i liÃªn há»‡ *</label>
            <input type="tel" id="contact" required placeholder="VD: (713) 123-4567">
          </div>

          <div class="form-actions" style="display:flex;gap:10px;margin-top:10px;padding-top:12px;border-top:2px solid #f0f0f0">
            <button type="button" class="btn" style="background:#999" onclick="closeModal()">Há»§y</button>
            <button type="submit" class="btn">ÄÄƒng bÃ¡n</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal chi tiáº¿t -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Chi tiáº¿t sáº£n pháº©m</h2>
        <button class="close-modal" onclick="closeDetailModal()">&times;</button>
      </div>
      <div class="modal-body" id="detailContent"></div>
    </div>
  </div>

  <!-- Zoom overlay -->
  <div id="zoomOverlay" class="zoom-overlay"><img id="zoomImg" alt=""></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    import 'https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.js';

    const SUPABASE_URL = 'https://wwlmvcsozavqfvwlxkrt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3bG12Y3NvemF2cWZ2d2x4a3J0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzUyMTMsImV4cCI6MjA2OTk1MTIxM30.HdxvLlqJgdntVUQDVtVlkjJJa7bn9CoIVUG8yn3WkLQ';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let allItems = [];
    let selectedFiles = [];
    let map, markersLayer;

    const esc = (s) => String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    // Nav mobile
    window.toggleNav = () => document.getElementById('navLinks').classList.toggle('active');

    // Auth (getSession Ä‘á»ƒ trÃ¡nh 403)
    async function checkAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      currentUser = session?.user ?? null;
      const userEmail = document.getElementById('userEmail');
      const logoutBtn = document.getElementById('logoutBtn');
      const postItemBtn = document.getElementById('postItemBtn');
      if (currentUser) {
        userEmail.textContent = currentUser.email;
        logoutBtn.style.display = 'block';
        postItemBtn.style.display = 'block';
      } else {
        userEmail.textContent = 'ChÆ°a Ä‘Äƒng nháº­p';
        logoutBtn.style.display = 'none';
        postItemBtn.style.display = 'none';
      }
      supabase.auth.onAuthStateChange((_e, sess) => {
        currentUser = sess?.user ?? null;
      });
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = 'login.html';
    });

    // Open modal Post
    document.getElementById('postItemBtn').addEventListener('click', () => {
      if (!currentUser) {
        alert('Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ Ä‘Äƒng bÃ¡n!');
        window.location.href = 'login.html';
        return;
      }
      document.getElementById('itemModal').style.display = 'block';
    });

    function closeModal() {
      document.getElementById('itemModal').style.display = 'none';
      document.getElementById('itemForm').reset();
      selectedFiles = [];
      document.getElementById('uploadPlaceholder').style.display = 'block';
      document.getElementById('imagePreviewList').style.display = 'none';
      document.getElementById('imagePreviewList').innerHTML = '';
      document.getElementById('uploadStatus').style.display = 'none';
    }
    window.closeModal = closeModal;

    function closeDetailModal(){ document.getElementById('detailModal').style.display='none' }
    window.closeDetailModal = closeDetailModal;

    // Image upload multiple
    const imageUploadArea = document.getElementById('imageUploadArea');
    const imageFilesInput = document.getElementById('imageFiles');
    imageUploadArea.addEventListener('click', (e)=>{ e.preventDefault(); imageFilesInput.click(); });
    imageUploadArea.addEventListener('dragover', (e)=>{ e.preventDefault(); imageUploadArea.style.background='#ffe5e5'; });
    imageUploadArea.addEventListener('dragleave', ()=>{ imageUploadArea.style.background='#fff5f5'; });
    imageUploadArea.addEventListener('drop', (e)=>{
      e.preventDefault(); imageUploadArea.style.background='#fff5f5';
      if(e.dataTransfer.files?.length){ handleFiles(Array.from(e.dataTransfer.files)); }
    });
    imageFilesInput.addEventListener('change', (e)=>{ if(e.target.files?.length){ handleFiles(Array.from(e.target.files)); } });

    function handleFiles(files){
      const newFiles = [];
      for(const f of files){
        if(!f.type.startsWith('image/')) { alert('Chá»‰ nháº­n file hÃ¬nh'); continue; }
        if(f.size > 5*1024*1024) { alert('Má»—i áº£nh tá»‘i Ä‘a 5MB'); continue; }
        newFiles.push(f);
      }
      const total = selectedFiles.length + newFiles.length;
      if(total > 10){ alert('Tá»‘i Ä‘a 10 áº£nh'); return; }
      selectedFiles = selectedFiles.concat(newFiles);
      renderPreview();
    }

    function renderPreview(){
      const list = document.getElementById('imagePreviewList');
      const ph = document.getElementById('uploadPlaceholder');
      if(selectedFiles.length === 0){
        list.style.display='none'; ph.style.display='block'; list.innerHTML=''; return;
      }
      list.style.display='flex'; ph.style.display='none'; list.innerHTML='';
      selectedFiles.forEach((file, idx)=>{
        const url = URL.createObjectURL(file);
        const wrap = document.createElement('div');
        wrap.style.position='relative';
        wrap.innerHTML = `
          <div style="width:80px;height:80px;border-radius:8px;overflow:hidden;border:1px solid #eee">
            <img src="${url}" style="width:100%;height:100%;object-fit:cover">
          </div>
          <button type="button" data-idx="${idx}" style="position:absolute;top:-8px;right:-8px;background:#dc143c;color:#fff;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer">Ã—</button>
        `;
        wrap.querySelector('button').onclick = (e)=>{
          const i = Number(e.currentTarget.getAttribute('data-idx'));
          selectedFiles.splice(i,1);
          renderPreview();
        };
        list.appendChild(wrap);
      });
    }

    async function uploadImages() {
      if(selectedFiles.length === 0) return [];
      const urls = [];
      for(const file of selectedFiles){
        const ext = file.name.split('.').pop();
        const name = `items/${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;
        const { error } = await supabase.storage.from('marketplace').upload(name, file);
        if(error){ console.error(error); continue; }
        urls.push(`${SUPABASE_URL}/storage/v1/object/public/marketplace/${name}`);
      }
      if(urls.length) document.getElementById('uploadStatus').style.display='block';
      return urls;
    }

    // Submit post
    document.getElementById('itemForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentUser){ alert('Vui lÃ²ng Ä‘Äƒng nháº­p!'); return; }
      const btn = e.target.querySelector('button[type="submit"]');
      const original = btn.textContent; btn.textContent='Äang xá»­ lÃ½...'; btn.disabled=true;
      try{
        const images = await uploadImages();
        const tagsRaw = document.getElementById('tags').value.trim();
        const tags = tagsRaw ? tagsRaw.split(',').map(t=>t.trim().toLowerCase()).filter(Boolean) : null;

        const itemData = {
          user_id: currentUser.id,
          title: document.getElementById('title').value,
          category: document.getElementById('category').value,
          price: parseFloat(document.getElementById('price').value),
          description: document.getElementById('description').value || '',
          condition: document.getElementById('condition').value,
          location: document.getElementById('location').value || '',
          city: document.getElementById('city').value,
          zipcode: document.getElementById('zipcode').value,
          contact: document.getElementById('contact').value,
          status: 'active',
          views: 0,
          images: images.length ? images : null,
          image_url: images[0] || null,
          tags
        };

        const { error } = await supabase.from('marketplace').insert([itemData]);
        if(error) throw error;
        alert('ÄÄƒng bÃ¡n thÃ nh cÃ´ng!');
        closeModal();
        await loadItems();
      }catch(err){
        console.error(err); alert('Lá»—i: ' + (err.message||'KhÃ´ng xÃ¡c Ä‘á»‹nh'));
      }finally{
        btn.textContent=original; btn.disabled=false;
      }
    });

    // Filters
    let searchDebounce;
    const reloadWithFilters = ()=> {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(()=>{
        const category = document.getElementById('categoryFilter').value;
        const searchTerm = document.getElementById('searchInput').value;
        const location = document.getElementById('locationInput').value;
        const priceMin = document.getElementById('priceMin').value;
        const priceMax = document.getElementById('priceMax').value;
        const sort = document.getElementById('sortSelect').value;
        const tags = document.getElementById('tagsFilter').value;
        const cond = Array.from(document.querySelectorAll('#conditionChecks input:checked')).map(i=>i.value);
        loadItems({category, searchTerm, location, priceMin, priceMax, sort, tags, conditions: cond});
      }, 400);
    };
    document.getElementById('searchInput').addEventListener('input', reloadWithFilters);
    document.getElementById('categoryFilter').addEventListener('change', reloadWithFilters);
    document.getElementById('locationInput').addEventListener('input', reloadWithFilters);
    document.getElementById('priceMin').addEventListener('input', reloadWithFilters);
    document.getElementById('priceMax').addEventListener('input', reloadWithFilters);
    document.getElementById('sortSelect').addEventListener('change', reloadWithFilters);
    document.getElementById('tagsFilter').addEventListener('input', reloadWithFilters);
    document.querySelectorAll('#conditionChecks input').forEach(c=>c.addEventListener('change', reloadWithFilters));

    // Wishlist toggle
    async function toggleFavorite(itemId, btnEl){
      if(!currentUser){ alert('Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ yÃªu thÃ­ch'); return; }
      try{
        const { data: exists } = await supabase.from('favorites').select('id').eq('user_id', currentUser.id).eq('item_id', itemId).maybeSingle();
        if(exists){
          await supabase.from('favorites').delete().eq('id', exists.id);
          btnEl.textContent = 'â™¡';
          btnEl.title = 'ThÃªm yÃªu thÃ­ch';
        }else{
          await supabase.from('favorites').insert([{ user_id: currentUser.id, item_id: itemId }]);
          btnEl.textContent = 'â¤';
          btnEl.title = 'Bá» yÃªu thÃ­ch';
        }
      }catch(e){ console.warn('Favorite error:', e); alert('KhÃ´ng thá»ƒ cáº­p nháº­t yÃªu thÃ­ch (kiá»ƒm tra báº£ng favorites)'); }
    }

    // Share
    function shareItem(item){
      const url = location.origin + location.pathname + `#item-${item.id}`;
      const text = `${item.title} - $${Number(item.price||0).toLocaleString()} trÃªn VietLinker`;
      if(navigator.share){
        navigator.share({ title: 'VietLinker', text, url }).catch(()=>{});
      }else{
        navigator.clipboard.writeText(url).then(()=> alert('ÄÃ£ copy link!'));
      }
    }

    // Review submit
    async function submitReview(itemId){
      if(!currentUser){ alert('Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ Ä‘Ã¡nh giÃ¡'); return; }
      const rating = Number(document.querySelector('#reviewStars input[name="rating"]:checked')?.value||0);
      const comment = document.getElementById('reviewComment').value.trim();
      if(!rating){ alert('Vui lÃ²ng chá»n sá»‘ sao'); return; }
      try{
        await supabase.from('reviews').insert([{ item_id:itemId, seller_id: null, reviewer_id: currentUser.id, rating, comment }]);
        alert('Cáº£m Æ¡n Ä‘Ã¡nh giÃ¡ cá»§a báº¡n!');
        await loadAndRenderReviews(itemId);
        document.getElementById('reviewComment').value='';
        document.querySelectorAll('#reviewStars input').forEach(i=>i.checked=false);
      }catch(e){ console.warn(e); alert('KhÃ´ng thá»ƒ gá»­i Ä‘Ã¡nh giÃ¡ (kiá»ƒm tra báº£ng reviews)'); }
    }

    async function loadAndRenderReviews(itemId){
      const wrap = document.getElementById('reviewsWrap');
      if(!wrap) return;
      wrap.innerHTML = '<div>Äang táº£i Ä‘Ã¡nh giÃ¡...</div>';
      try{
        const { data } = await supabase.from('reviews').select('*').eq('item_id', itemId).order('created_at',{ascending:false});
        if(!data?.length){ wrap.innerHTML='<div>ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡</div>'; return; }
        const avg = (data.reduce((s,r)=>s+(r.rating||0),0)/data.length).toFixed(1);
        document.getElementById('avgRating').textContent = `${avg} â­ (${data.length})`;
        wrap.innerHTML = data.map(r=>`
          <div class="review">
            <div style="font-weight:700;color:#1e3c72">${'â­'.repeat(r.rating||0)}</div>
            <div style="color:#555">${esc(r.comment||'')}</div>
            <div style="color:#999;font-size:.85em">${new Date(r.created_at).toLocaleString('vi-VN')}</div>
          </div>
        `).join('');
      }catch{ wrap.innerHTML='<div>KhÃ´ng táº£i Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡</div>'; }
    }

    // Messages: send to seller
    async function sendMessageToSeller(sellerId, itemId){
      if(!currentUser){ alert('Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ nháº¯n tin'); return; }
      const msg = prompt('Ná»™i dung tin nháº¯n Ä‘áº¿n ngÆ°á»i bÃ¡n:');
      if(!msg) return;
      try{
        await supabase.from('messages').insert([{ sender_id: currentUser.id, receiver_id: sellerId, item_id: itemId, message: msg, is_read:false }]);
        alert('ÄÃ£ gá»­i tin nháº¯n!');
      }catch(e){ console.warn(e); alert('KhÃ´ng thá»ƒ gá»­i tin nháº¯n (kiá»ƒm tra báº£ng messages)'); }
    }

    // Report
    async function reportItem(itemId){
      if(!currentUser){ alert('Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ bÃ¡o cÃ¡o'); return; }
      const reason = prompt('LÃ½ do bÃ¡o cÃ¡o sáº£n pháº©m nÃ y?');
      if(!reason) return;
      try{
        await supabase.from('reports').insert([{ item_id: itemId, user_id: currentUser.id, reason }]);
        alert('ÄÃ£ gá»­i bÃ¡o cÃ¡o. Cáº£m Æ¡n!');
      }catch(e){ console.warn(e); alert('KhÃ´ng thá»ƒ bÃ¡o cÃ¡o (kiá»ƒm tra báº£ng reports)'); }
    }

    // Follow seller
    async function followSeller(sellerId, btn){
      if(!currentUser){ alert('Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ theo dÃµi'); return; }
      try{
        const { data: f } = await supabase.from('follows').select('id').eq('follower_id',currentUser.id).eq('seller_id',sellerId).maybeSingle();
        if(f){
          await supabase.from('follows').delete().eq('id', f.id);
          btn.textContent='Theo dÃµi';
        }else{
          await supabase.from('follows').insert([{ follower_id:currentUser.id, seller_id:sellerId }]);
          btn.textContent='Äang theo dÃµi';
        }
      }catch(e){ console.warn(e); alert('KhÃ´ng thá»ƒ cáº­p nháº­t theo dÃµi (kiá»ƒm tra báº£ng follows)'); }
    }

    // Map
    function ensureMap(){
      if(map) return;
      map = L.map('map').setView([39.5,-98.35],4); // center US
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: '&copy; OpenStreetMap' }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    document.getElementById('toggleMapBtn').addEventListener('click', ()=>{
      const wrap = document.getElementById('mapWrap');
      if(wrap.style.display==='none' || wrap.style.display===''){ wrap.style.display='block'; ensureMap(); plotMarkers(); setTimeout(()=>map.invalidateSize(), 50); }
      else { wrap.style.display='none'; }
    });

    function plotMarkers(){
      if(!map || !markersLayer) return;
      markersLayer.clearLayers();
      const withCoords = allItems.filter(i => typeof i.lat === 'number' && typeof i.lng === 'number');
      if(!withCoords.length){ return; }
      withCoords.forEach((item)=>{
        const m = L.marker([item.lat, item.lng]).addTo(markersLayer);
        m.bindPopup(`<div style="min-width:160px"><b>${esc(item.title)}</b><br>$${Number(item.price||0).toLocaleString()}</div>`);
        m.on('click', ()=> showItemDetail(item));
      });
      const group = L.featureGroup(withCoords.map(i=>L.marker([i.lat,i.lng])));
      try{ map.fitBounds(group.getBounds().pad(0.2)); }catch{}
    }

    // Load items with filters
    async function loadItems(filters = {}){
      const container = document.getElementById('itemsContainer');
      container.innerHTML = '<div class="loading">Äang táº£i sáº£n pháº©m...</div>';

      try{
        let query = supabase.from('marketplace').select('*').eq('status','active');

        if(filters.category) query = query.eq('category', filters.category);
        if(filters.searchTerm) query = query.or(`title.ilike.%${filters.searchTerm}%,description.ilike.%${filters.searchTerm}%`);
        if(filters.location){
          if(/^\d{5}$/.test(filters.location)) query = query.eq('zipcode', filters.location);
          else query = query.ilike('city', `%${filters.location}%`);
        }
        if(filters.conditions?.length){
          query = query.in('condition', filters.conditions);
        }
        if(filters.priceMin){ query = query.gte('price', Number(filters.priceMin)); }
        if(filters.priceMax){ query = query.lte('price', Number(filters.priceMax)); }
        if(filters.tags){
          const tag = filters.tags.trim().toLowerCase();
          if(tag) query = query.contains('tags', [tag]);
        }

        // sort
        if(filters.sort==='price_asc') query = query.order('price', { ascending:true }).order('created_at', { ascending:false });
        else if(filters.sort==='price_desc') query = query.order('price', { ascending:false }).order('created_at', { ascending:false });
        else query = query.order('created_at', { ascending:false });

        const { data: items, error } = await query;
        if(error) throw error;

        allItems = items || [];
        if(document.getElementById('mapWrap').style.display==='block'){ plotMarkers(); }

        if(!items?.length){
          container.innerHTML = `<div class="empty-state"><h3>ğŸ” KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m nÃ o</h3><p>HÃ£y thá»­ tÃ¬m kiáº¿m vá»›i tá»« khÃ³a khÃ¡c!</p></div>`;
          return;
        }

        const categoryIcons = {car:'ğŸš—',motorcycle:'ğŸï¸',electronics:'ğŸ“±',furniture:'ğŸ›‹ï¸',appliances:'ğŸ ',clothing:'ğŸ‘•',jewelry:'ğŸ’',sports:'âš½',toys:'ğŸ§¸',food:'ğŸœ',other:'ğŸ“¦'};

        const html = items.map(item=>{
          const loc = [item.city, item.zipcode].filter(Boolean).join(', ');
          const img = (Array.isArray(item.images) && item.images[0]) ? item.images[0] : (item.image_url || '');
          const heart = 'â™¡';
          return `
            <div class="item-card" data-id="${esc(item.id)}">
              ${item.condition==='new' ? '<div class="item-badge">Má»šI</div>' : ''}
              <button class="item-heart" title="ThÃªm yÃªu thÃ­ch" data-heart> ${heart} </button>
              <div class="item-image" data-open>
                ${img ? `<img src="${esc(img)}" alt="${esc(item.title||'')}" onerror="this.parentElement.innerHTML='${categoryIcons[item.category]||'ğŸ“¦'}'">` : (categoryIcons[item.category]||'ğŸ“¦')}
              </div>
              <div class="item-body" data-open>
                <div class="item-category">${esc(item.category||'KhÃ¡c')}</div>
                <div class="item-title">${esc(item.title||'')}</div>
                <div class="item-price">$${Number(item.price||0).toLocaleString()}</div>
                <div class="item-details">
                  <div><span class="icon">ğŸ“</span> ${esc(loc)||'KhÃ´ng rÃµ'}</div>
                  <div><span class="icon">ğŸ‘ï¸</span> ${item.views||0} lÆ°á»£t xem</div>
                </div>
              </div>
            </div>
          `;
        }).join('');
        container.innerHTML = html;

        // Bind events
        container.querySelectorAll('.item-card').forEach(card=>{
          const id = card.getAttribute('data-id');
          card.querySelector('[data-open]').addEventListener('click', ()=>{
            const item = allItems.find(i => String(i.id)===String(id));
            if(item) showItemDetail(item);
          });
          card.querySelector('[data-heart]').addEventListener('click', async (e)=>{
            e.stopPropagation();
            await toggleFavorite(id, e.currentTarget);
          });
        });

      }catch(err){
        console.error(err);
        container.innerHTML = '<div class="empty-state">Lá»—i khi táº£i dá»¯ liá»‡u</div>';
      }
    }

    // Detail with gallery, wishlist, share, chat, follow, report, reviews, Q&A (simple)
    async function showItemDetail(item){
      // fetch seller profile
      let sellerProfile = null;
      try{
        if(item.user_id){
          const { data } = await supabase.from('users').select('full_name,is_verified').eq('id', item.user_id).maybeSingle();
          sellerProfile = data || null;
        }
      }catch{}

      const imgs = Array.isArray(item.images) && item.images.length ? item.images : (item.image_url ? [item.image_url] : []);
      const firstImg = imgs[0] || '';
      const loc = [item.city, item.zipcode].filter(Boolean).join(', ');
      const isVerified = sellerProfile?.is_verified;

      const detail = document.getElementById('detailContent');
      detail.innerHTML = `
        <div class="gallery">
          <div class="gallery-main">${firstImg ? `<img id="gMain" src="${esc(firstImg)}" alt="${esc(item.title||'')}" />` : '<div style="font-size:64px">ğŸ“¦</div>'}</div>
          ${imgs.length>1 ? `
            <div class="gallery-nav">
              <button class="nav-btn" id="gPrev">â€¹</button>
              <button class="nav-btn" id="gNext">â€º</button>
            </div>
          `:''}
          <div class="gallery-thumbs" id="gThumbs">
            ${imgs.map((u,ix)=>`
              <div class="thumb ${ix===0?'active':''}" data-ix="${ix}"><img src="${esc(u)}" alt="thumb ${ix+1}"></div>
            `).join('')}
          </div>
        </div>

        <h3 class="detail-title">${esc(item.title||'')}</h3>
        <div class="detail-price">$${Number(item.price||0).toLocaleString()}</div>

        <div class="detail-actions">
          <button class="btn" id="favBtn">â¤ YÃªu thÃ­ch</button>
          <button class="btn btn-outline" id="shareBtn">ğŸ”— Chia sáº»</button>
          ${item.user_id ? `<button class="btn btn-outline" id="chatBtn">ğŸ’¬ Nháº¯n tin</button>`:''}
          ${item.user_id ? `<button class="btn btn-outline" id="followBtn">ğŸ‘¤ ${'Theo dÃµi'}</button>`:''}
          <button class="btn btn-outline" id="reportBtn">ğŸ›¡ï¸ BÃ¡o cÃ¡o</button>
        </div>

        <div class="detail-row" style="margin-top:10px">
          <div class="detail-meta">
            ${item.category ? `<div class="meta-item"><div class="label">ğŸ“¦ Danh má»¥c:</div><div>${esc(item.category)}</div></div>`:''}
            ${item.condition ? `<div class="meta-item"><div class="label">âœ¨ TÃ¬nh tráº¡ng:</div><div>${esc(item.condition)}</div></div>`:''}
            ${loc ? `<div class="meta-item"><div class="label">ğŸ“ Khu vá»±c:</div><div>${esc(loc)}</div></div>`:''}
            <div class="meta-item"><div class="label">ğŸ“… NgÃ y Ä‘Äƒng:</div><div>${new Date(item.created_at).toLocaleDateString('vi-VN')}</div></div>
            <div class="meta-item"><div class="label">ğŸ‘ï¸ LÆ°á»£t xem:</div><div>${item.views||0}</div></div>
            ${item.contact ? `<div class="meta-item"><div class="label">ğŸ“ LiÃªn há»‡:</div><div>${esc(item.contact)}</div></div>`:''}
            ${isVerified ? `<div class="meta-item"><div class="label">âœ… NgÆ°á»i bÃ¡n:</div><div>${esc(sellerProfile?.full_name||'NgÆ°á»i bÃ¡n')} (Verified)</div></div>` :
              (sellerProfile?.full_name ? `<div class="meta-item"><div class="label">ğŸ‘¤ NgÆ°á»i bÃ¡n:</div><div>${esc(sellerProfile.full_name)}</div></div>`:'')
            }
            ${Array.isArray(item.tags)&&item.tags.length ? `<div class="meta-item"><div class="label">ğŸ·ï¸ Tags:</div><div>${item.tags.map(t=>`<span class="tag">${esc(t)}</span>`).join('')}</div></div>`:''}
          </div>

          ${item.description ? `<div class="detail-description"><h4 style="margin-bottom:8px;color:#1e3c72">MÃ´ táº£ chi tiáº¿t</h4><div>${esc(item.description).replace(/\n/g,'<br>')}</div></div>`:''}
        </div>

        ${ (typeof item.lat==='number' && typeof item.lng==='number') ? `
          <div style="margin-top:12px">
            <div class="section-title">Vá»‹ trÃ­</div>
            <div id="mapDetail" style="width:100%;height:260px;border-radius:10px;overflow:hidden"></div>
          </div>`:''}

        <div style="margin-top:16px">
          <div class="section-title">ÄÃ¡nh giÃ¡ <span id="avgRating" style="font-weight:600"></span></div>
          <div id="reviewsWrap" style="margin-bottom:10px"></div>
          <div id="reviewForm">
            <div id="reviewStars" class="stars" style="margin-bottom:8px">
              ${[5,4,3,2,1].map(v=>`<label title="${v} sao"><input type="radio" name="rating" value="${v}" style="display:none"><span class="star">â­</span></label>`).join('')}
            </div>
            <textarea id="reviewComment" rows="3" placeholder="Nháº­n xÃ©t cá»§a báº¡n..." style="width:100%;border:1px solid #e0e0e0;border-radius:8px;padding:8px"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" id="sendReviewBtn">Gá»­i Ä‘Ã¡nh giÃ¡</button>
            </div>
          </div>
        </div>

        <div style="margin-top:16px">
          <div class="section-title">Há»i Ä‘Ã¡p</div>
          <div id="qaWrap"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="qaInput" placeholder="Äáº·t cÃ¢u há»i cho ngÆ°á»i bÃ¡n..." style="flex:1;border:1px solid #e0e0e0;border-radius:8px;padding:10px">
            <button class="btn btn-outline" id="qaSendBtn">Gá»­i</button>
          </div>
        </div>
      `;

      // Gallery handlers
      const mainImg = document.getElementById('gMain');
      const thumbs = Array.from(document.querySelectorAll('#gThumbs .thumb'));
      let currentIx = 0;
      function setActive(ix){
        currentIx = (ix + imgs.length) % imgs.length;
        if(mainImg) mainImg.src = imgs[currentIx];
        thumbs.forEach((t,i)=> t.classList.toggle('active', i===currentIx));
      }
      thumbs.forEach(t=> t.addEventListener('click', ()=> setActive(Number(t.getAttribute('data-ix')))));
      const prev = document.getElementById('gPrev'), next = document.getElementById('gNext');
      if(prev) prev.addEventListener('click', ()=> setActive(currentIx-1));
      if(next) next.addEventListener('click', ()=> setActive(currentIx+1));

      // Zoom
      const zoomOverlay = document.getElementById('zoomOverlay');
      const zoomImg = document.getElementById('zoomImg');
      if(mainImg){
        mainImg.addEventListener('click', ()=>{ zoomImg.src = mainImg.src; zoomOverlay.style.display='flex'; });
        zoomOverlay.addEventListener('click', ()=> zoomOverlay.style.display='none');
      }

      // Buttons
      document.getElementById('shareBtn').addEventListener('click', ()=> shareItem(item));
      document.getElementById('reportBtn').addEventListener('click', ()=> reportItem(item.id));
      const favBtn = document.getElementById('favBtn');
      favBtn.addEventListener('click', async ()=> {
        await toggleFavorite(item.id, favBtn);
      });
      if(item.user_id){
        document.getElementById('chatBtn')?.addEventListener('click', ()=> sendMessageToSeller(item.user_id, item.id));
        const followBtn = document.getElementById('followBtn');
        followBtn.addEventListener('click', ()=> followSeller(item.user_id, followBtn));
      }

      // Reviews
      document.getElementById('sendReviewBtn').addEventListener('click', ()=> submitReview(item.id));
      document.querySelectorAll('#reviewStars .star').forEach((s,idx)=>{
        s.addEventListener('click', ()=>{
          const val = 5 - idx;
          const input = document.querySelector(`#reviewStars input[value="${val}"]`);
          if(input) input.checked = true;
          document.querySelectorAll('#reviewStars .star').forEach((st,i)=> st.classList.toggle('active', i<=idx));
        });
      });
      await loadAndRenderReviews(item.id);

      // Q&A
      await loadQA(item.id);
      document.getElementById('qaSendBtn').addEventListener('click', ()=> sendQuestion(item.id));

      // Map detail
      if(typeof item.lat==='number' && typeof item.lng==='number'){
        const md = L.map('mapDetail').setView([item.lat,item.lng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap' }).addTo(md);
        L.marker([item.lat,item.lng]).addTo(md).bindPopup(esc(item.title||''));
        setTimeout(()=>md.invalidateSize(), 50);
      }

      // Update view count
      try{
        const { data: it } = await supabase.from('marketplace').select('views').eq('id', item.id).single();
        await supabase.from('marketplace').update({ views: (it?.views||0)+1 }).eq('id', item.id);
      }catch{}

      document.getElementById('detailModal').style.display='block';
    }
    window.showItemDetail = showItemDetail;

    // Q&A
    async function loadQA(itemId){
      const wrap = document.getElementById('qaWrap');
      wrap.innerHTML = 'Äang táº£i...';
      try{
        const { data } = await supabase.from('questions').select('*').eq('item_id', itemId).order('created_at',{ascending:false});
        if(!data?.length){ wrap.innerHTML = '<div>ChÆ°a cÃ³ cÃ¢u há»i</div>'; return; }
        wrap.innerHTML = data.map(q=>`
          <div style="border:1px solid #eee;border-radius:8px;padding:10px;margin-bottom:8px">
            <div style="color:#1e3c72;font-weight:700">â“ ${esc(q.question||'')}</div>
            ${q.answer ? `<div style="margin-top:6px;color:#2b8a3e">ğŸ’¬ ${esc(q.answer||'')}</div>`:''}
            <div style="color:#999;font-size:.85em;margin-top:6px">${new Date(q.created_at).toLocaleString('vi-VN')}</div>
          </div>
        `).join('');
      }catch{ wrap.innerHTML = '<div>KhÃ´ng táº£i Ä‘Æ°á»£c Q&A (kiá»ƒm tra báº£ng questions)</div>'; }
    }
    async function sendQuestion(itemId){
      if(!currentUser){ alert('Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ há»i'); return; }
      const val = document.getElementById('qaInput').value.trim();
      if(!val) return;
      try{
        await supabase.from('questions').insert([{ item_id:itemId, user_id: currentUser.id, question: val }]);
        document.getElementById('qaInput').value='';
        await loadQA(itemId);
      }catch(e){ console.warn(e); alert('KhÃ´ng thá»ƒ gá»­i cÃ¢u há»i (kiá»ƒm tra báº£ng questions)'); }
    }

    // Map toggle init markers later

    // Init
    await checkAuth();
    await loadItems();

  </script>
</body>
</html>
