<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mua B√°n - VietLinker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }

        /* Mobile-first approach */
        .container {
            background: white;
            min-height: 100vh;
        }

        header {
            background: linear-gradient(135deg, #1e3c72 0%, #dc143c 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }

        header p {
            font-size: 0.95em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        /* Mobile Navigation */
        nav {
            background: #1e3c72;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-toggle {
            display: block;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .nav-links {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1e3c72;
            flex-direction: column;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-links.active {
            display: flex;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 12px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .nav-links a:hover,
        .nav-links a.active {
            background: rgba(220, 20, 60, 0.3);
        }

        .user-info {
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }

        .logout-btn {
            background: #dc143c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }

        .logout-btn:hover {
            background: #b91c3c;
            transform: scale(1.05);
        }

        .main-content {
            padding: 20px;
            background: #f8f9fa;
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e3c72;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Optimized Actions Bar */
        .actions-bar {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-filter-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .filter-btn {
            background: #1e3c72;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .filter-btn:hover {
            background: #2a5298;
            transform: translateY(-2px);
        }

        .post-btn {
            background: #dc143c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
        }

        .post-btn:hover {
            background: #b91c3c;
            transform: translateY(-2px);
        }

        /* Optimized Items Grid */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .item-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .item-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .item-image.loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .item-content {
            padding: 15px;
        }

        .item-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            line-height: 1.3;
        }

        .item-price {
            font-size: 1.2em;
            font-weight: 700;
            color: #dc143c;
            margin-bottom: 8px;
        }

        .item-location {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }

        .item-date {
            font-size: 0.8em;
            color: #999;
        }

        .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .favorite-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .favorite-btn.active {
            color: #dc143c;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .page-btn:hover,
        .page-btn.active {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
            }

            .search-filter-row {
                flex-direction: column;
            }

            .search-box {
                min-width: auto;
            }

            .item-card {
                margin-bottom: 0;
            }

            .item-image {
                height: 180px;
            }
        }

        @media (max-width: 480px) {
            .items-grid {
                grid-template-columns: 1fr;
            }

            .item-image {
                height: 200px;
            }
        }

        /* Footer */
        footer {
            background: #1e3c72;
            color: white;
            padding: 30px 20px;
            margin-top: 40px;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }

        .footer-column h4 {
            margin-bottom: 15px;
            color: #FFD700;
        }

        .footer-column ul {
            list-style: none;
        }

        .footer-column ul li {
            margin-bottom: 8px;
        }

        .footer-column ul li a {
            color: white;
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-column ul li a:hover {
            color: #FFD700;
        }

        .footer-bottom {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè™ Mua B√°n</h1>
            <p>K·∫øt n·ªëi ng∆∞·ªùi mua v√† ng∆∞·ªùi b√°n trong c·ªông ƒë·ªìng Vi·ªát</p>
        </header>

        <nav>
            <div class="nav-wrapper">
                <button class="nav-toggle" onclick="toggleNav()">‚ò∞</button>
                <div class="nav-links" id="navLinks">
                    <a href="index.html">üè† Trang Ch·ªß</a>
                    <a href="marketplace.html" class="active">üè™ Mua B√°n</a>
                    <a href="jobs.html">üíº Vi·ªác L√†m</a>
                    <a href="services.html">üîß D·ªãch V·ª•</a>
                    <a href="food.html">üçú ·∫®m Th·ª±c</a>
                    <a href="realestate.html">üè† B·∫•t ƒê·ªông S·∫£n</a>
                    <a href="classifieds.html">üì∞ Rao V·∫∑t</a>
                </div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <span id="userName">User</span>
                    <button class="logout-btn" onclick="logout()">ƒêƒÉng Xu·∫•t</button>
                </div>
            </div>
        </nav>

        <div class="main-content">
            <div class="actions-bar">
                <div class="search-filter-row">
                    <input type="text" class="search-box" id="searchBox" placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m..." oninput="debounceSearch()">
                    <button class="filter-btn" onclick="showFilters()">üîß B·ªô L·ªçc</button>
                    <button class="post-btn" onclick="goToPost()">ÔøΩÔøΩ ƒêƒÉng Tin</button>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <span>ƒêang t·∫£i...</span>
            </div>

            <div id="itemsGrid" class="items-grid" style="display: none;"></div>

            <div id="pagination" class="pagination" style="display: none;"></div>
        </div>

        <footer>
            <div class="footer-content">
                <div class="footer-column">
                    <h4>H·ªó Tr·ª£</h4>
                    <ul>
                        <li><a href="contact.html">Li√™n H·ªá</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>V·ªÅ VietLinker</h4>
                    <ul>
                        <li><a href="about.html">Gi·ªõi Thi·ªáu</a></li>
                        <li><a href="terms.html">ƒêi·ªÅu Kho·∫£n</a></li>
                        <li><a href="privacy.html">Ch√≠nh S√°ch B·∫£o M·∫≠t</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h4>D·ªãch V·ª•</h4>
                    <ul>
                        <li><a href="contact.html">Qu·∫£ng C√°o</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 VietLinker. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Performance optimizations - GI·ªÆ NGUY√äN T·∫§T C·∫¢ CH·ª®C NƒÇNG
        let searchTimeout;
        let currentPage = 1;
        let itemsPerPage = 12;
        let allItems = [];
        let filteredItems = [];
        let currentUser = null;
        let favorites = new Set();
        let isLoading = false; // Prevent multiple simultaneous loads

        // Debounced search for better performance
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterItems();
            }, 300);
        }

        // Initialize with better error handling
        async function initialize() {
            try {
                console.log('üöÄ VietLinker Marketplace Starting...');
                
                // Check auth first (non-blocking)
                checkAuth().then(() => {
                    // Load favorites in background if user is logged in
                    if (currentUser) {
                        loadFavorites();
                    }
                });
                
                // Load items immediately
                await loadItems();
                
                console.log('‚úÖ VietLinker Marketplace Ready!');
            } catch (error) {
                console.error('‚ùå Error initializing:', error);
                showError('C√≥ l·ªói x·∫£y ra khi t·∫£i trang. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // Optimized auth check - GI·ªÆ NGUY√äN CH·ª®C NƒÇNG
        async function checkAuth() {
            const supabase = getSupabase();
            if (!supabase) return;

            try {
                const { data: { session } } = await supabase.auth.getSession();
                currentUser = session?.user || null;
                
                const userInfo = document.getElementById('userInfo');
                const userName = document.getElementById('userName');
                
                if (currentUser) {
                    userName.textContent = currentUser.email || 'User';
                    userInfo.style.display = 'flex';
                } else {
                    userInfo.style.display = 'none';
                }
            } catch (error) {
                console.warn('Auth check warning:', error);
            }
        }

        // Optimized item loading - GI·ªÆ NGUY√äN CH·ª®C NƒÇNG
        async function loadItems() {
            if (isLoading) return; // Prevent multiple loads
            
            isLoading = true;
            const loading = document.getElementById('loading');
            const itemsGrid = document.getElementById('itemsGrid');
            
            loading.style.display = 'flex';
            itemsGrid.style.display = 'none';

            try {
                const supabase = getSupabase();
                if (!supabase) throw new Error('Supabase not available');

                // Optimized query - only get what we need
                const { data, error } = await supabase
                    .from('marketplace')
                    .select('id, title, description, price, city, image_url, created_at, user_id')
                    .order('created_at', { ascending: false })
                    .limit(100); // Limit for performance

                if (error) throw error;

                allItems = data || [];
                filteredItems = [...allItems];
                
                // Render immediately
                renderItems();
                
            } catch (error) {
                console.error('Error loading items:', error);
                showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i.');
            } finally {
                loading.style.display = 'none';
                isLoading = false;
            }
        }

        // Optimized rendering - GI·ªÆ NGUY√äN CH·ª®C NƒÇNG
        function renderItems() {
            const itemsGrid = document.getElementById('itemsGrid');
            const pagination = document.getElementById('pagination');
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = filteredItems.slice(startIndex, endIndex);

            if (pageItems.length === 0) {
                itemsGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o.</div>';
                itemsGrid.style.display = 'block';
                pagination.style.display = 'none';
                return;
            }

            // Optimized HTML generation
            const itemsHTML = pageItems.map(item => `
                <div class="item-card" onclick="viewItem('${item.id}')">
                    <img src="${escapeHtml(item.image_url || '')}" 
                         alt="${escapeHtml(item.title)}" 
                         class="item-image"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjBGMEYwIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7DgW5oIGNo4bqldSB0w6A8L3RleHQ+Cjwvc3ZnPgo='"
                         loading="lazy">
                    <button class="favorite-btn ${favorites.has(item.id) ? 'active' : ''}" 
                            onclick="event.stopPropagation(); toggleFavorite('${item.id}')">
                        ${favorites.has(item.id) ? '‚ù§Ô∏è' : 'ü§ç'}
                    </button>
                    <div class="item-content">
                        <div class="item-title">${escapeHtml(item.title)}</div>
                        <div class="item-price">$${formatPrice(item.price)}</div>
                        <div class="item-location">üìç ${escapeHtml(item.city || 'N/A')}</div>
                        <div class="item-date">${formatDate(item.created_at)}</div>
                    </div>
                </div>
            `).join('');

            itemsGrid.innerHTML = itemsHTML;
            itemsGrid.style.display = 'block';
            renderPagination();
        }

        // Optimized pagination - GI·ªÆ NGUY√äN CH·ª®C NƒÇNG
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            let paginationHTML = '';
            
            // Previous button
            if (currentPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage - 1})">‚Üê</button>`;
            }

            // Page numbers - optimized to show fewer buttons
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += `<span style="padding: 8px 12px;">...</span>`;
                }
            }

            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage + 1})">‚Üí</button>`;
            }

            pagination.innerHTML = paginationHTML;
            pagination.style.display = 'flex';
        }

        // Optimized filtering - GI·ªÆ NGUY√äN CH·ª®C NƒÇNG
        function filterItems() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            // Optimized filtering
            filteredItems = allItems.filter(item => 
                item.title?.toLowerCase().includes(searchTerm) ||
                item.description?.toLowerCase().includes(searchTerm) ||
                item.city?.toLowerCase().includes(searchTerm)
            );

            currentPage = 1;
            renderItems();
        }

        // Optimized favorites - GI·ªÆ NGUY√äN CH·ª®C NƒÇNG
        async function loadFavorites() {
            if (!currentUser) return;
            
            try {
                const supabase = getSupabase();
                const { data } = await supabase
                    .from('favorites')
                    .select('item_id')
                    .eq('user_id', currentUser.id);

                favorites.clear();
                data?.forEach(fav => favorites.add(fav.item_id));
            } catch (error) {
                console.warn('Error loading favorites:', error);
            }
        }

        async function toggleFavorite(itemId) {
            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ y√™u th√≠ch s·∫£n ph·∫©m.');
                return;
            }

            try {
                const supabase = getSupabase();
                const isFavorited = favorites.has(itemId);

                if (isFavorited) {
                    await supabase
                        .from('favorites')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .eq('item_id', itemId);
                    favorites.delete(itemId);
                } else {
                    await supabase
                        .from('favorites')
                        .insert({ user_id: currentUser.id, item_id: itemId });
                    favorites.add(itemId);
                }

                // Update UI immediately
                const btn = event.target.closest('.favorite-btn');
                if (btn) {
                    btn.classList.toggle('active');
                    btn.innerHTML = favorites.has(itemId) ? '‚ù§Ô∏è' : 'ü§ç';
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
                alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // Utility functions - GI·ªÆ NGUY√äN CH·ª®C NƒÇNG
        function changePage(page) {
            currentPage = page;
            renderItems();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function viewItem(itemId) {
            // Navigate to item detail page
            window.location.href = `item-detail.html?id=${itemId}`;
        }

        function goToPost() {
            window.location.href = 'post-form.html';
        }

        function showFilters() {
            // Simple filter modal or expand filter options
            alert('T√≠nh nƒÉng b·ªô l·ªçc n√¢ng cao s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t s·ªõm!');
        }

        function toggleNav() {
            const navLinks = document.getElementById('navLinks');
            navLinks.classList.toggle('active');
        }

        async function logout() {
            try {
                const supabase = getSupabase();
                await supabase.auth.signOut();
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function getSupabase() {
            return window.supabase;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('en-US').format(price || 0);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }

        function showError(message) {
            const itemsGrid = document.getElementById('itemsGrid');
            itemsGrid.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc143c;">${message}</div>`;
            itemsGrid.style.display = 'block';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
